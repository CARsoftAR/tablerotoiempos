{% extends 'base.html' %}

{% block title %}Estadísticas Avanzadas{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <!-- Top Bar & Filters -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                Analíticas Avanzadas
            </h1>
            <p class="text-slate-500 mt-2 font-medium">Visualización estratégica del desempeño productivo.</p>
        </div>
        
        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button id="btnFullScreen" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold transition-all flex items-center gap-2" title="Pantalla Completa">
                <i class="fas fa-expand"></i>
                <span class="hidden sm:inline">Modo TV</span>
            </button>

            <!-- Date Selector -->
            <form method="get" class="flex bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm">
                <button type="submit" name="period" value="7" class="px-4 py-2 rounded-lg text-sm font-bold transition-all {% if period == 7 %}bg-indigo-600 text-white shadow-lg{% else %}text-slate-500 hover:text-indigo-600 hover:bg-indigo-50{% endif %}">
                    7 Días
                </button>
                <button type="submit" name="period" value="15" class="px-4 py-2 rounded-lg text-sm font-bold transition-all {% if period == 15 %}bg-indigo-600 text-white shadow-lg{% else %}text-slate-500 hover:text-indigo-600 hover:bg-indigo-50{% endif %}">
                    15 Días
                </button>
                <button type="submit" name="period" value="30" class="px-4 py-2 rounded-lg text-sm font-bold transition-all {% if period == 30 %}bg-indigo-600 text-white shadow-lg{% else %}text-slate-500 hover:text-indigo-600 hover:bg-indigo-50{% endif %}">
                    30 Días
                </button>
            </form>
        </div>
    </div>

    <!-- OEE Trend Chart (HERO) -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden mb-6">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-1"><i class="fas fa-wave-square text-indigo-600 mr-2"></i>Tendencia de Eficiencia (OEE)</h3>
                <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Evolución Diaria</p>
            </div>
            <div class="text-right">
                <span class="block text-2xl font-black text-slate-800" id="avgOeeValue">--%</span>
                <span class="text-xs text-indigo-600 font-bold uppercase tracking-wider">Promedio del Periodo</span>
            </div>
        </div>
        <div class="p-6 relative">
            <div id="chartOeeTrend" class="w-full h-[350px]"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Pareto Chart (Downtime) -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-lg font-bold text-slate-800 mb-1"><i class="fas fa-exclamation-circle text-rose-500 mr-2"></i>Pareto de Paradas</h3>
                <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Distribución de Tiempos Perdidos (Minutos)</p>
            </div>
            <div class="p-6 flex-1 flex items-center justify-center relative">
                 <div id="chartPareto" class="w-full h-[350px]"></div>
                 <!-- Empty State if no data -->
                 <div id="paretoEmpty" class="absolute inset-0 hidden flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-check-circle text-4xl mb-2 text-emerald-500"></i>
                    <p class="font-bold text-sm">Sin paradas significativas registradas</p>
                 </div>
            </div>
        </div>

        <!-- Ranking Table (Operators) -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden flex flex-col">
             <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1"><i class="fas fa-trophy text-amber-500 mr-2"></i>Ranking de Operadores</h3>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Top Performance acumulado</p>
                </div>
                 <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600">
                    <i class="fas fa-crown text-sm"></i>
                 </div>
            </div>
            <div class="overflow-y-auto max-h-[400px]">
                <table class="w-full">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr class="text-left text-[10px] uppercase tracking-wider text-slate-400 font-bold border-b border-slate-200">
                            <th class="px-6 py-4">#</th>
                            <th class="px-6 py-4">Operario</th>
                            <th class="px-6 py-4 text-center">OEE Prom.</th>
                            <th class="px-6 py-4 text-right">Prod. Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for op in ranking_data %}
                        <tr class="hover:bg-slate-50 transition-colors group">
                             <td class="px-6 py-4 font-mono text-slate-400 text-xs">
                                {% if forloop.counter == 1 %}
                                    <i class="fas fa-medal text-amber-400 text-lg drop-shadow-sm"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="fas fa-medal text-slate-400 text-lg"></i>
                                {% elif forloop.counter == 3 %}
                                    <i class="fas fa-medal text-amber-700 text-lg"></i>
                                {% else %}
                                    {{ forloop.counter }}
                                {% endif %}
                             </td>
                             <td class="px-6 py-4">
                                <div class="font-bold text-slate-700 group-hover:text-indigo-700 transition-colors">{{ op.name }}</div>
                                <div class="text-[10px] text-slate-400 font-mono">{{ op.legajo }}</div>
                             </td>
                             <td class="px-6 py-4 text-center">
                                <span class="px-2 py-1 rounded-md text-xs font-bold {% if op.oee >= 85 %}bg-emerald-100 text-emerald-700 border border-emerald-200{% elif op.oee >= 60 %}bg-amber-100 text-amber-700 border border-amber-200{% else %}bg-rose-100 text-rose-700 border border-rose-200{% endif %}">
                                    {{ op.oee }}%
                                </span>
                             </td>
                             <td class="px-6 py-4 text-right">
                                <span class="font-mono text-slate-600 font-bold">{{ op.total_qty|floatformat:0 }}</span>
                                <span class="text-[10px] text-slate-400 block">unidades</span>
                             </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400 text-sm">
                                Sin datos de producción en el periodo.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>


<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center transition-opacity duration-300">
    <div class="relative">
        <!-- Modern Spinner -->
        <div class="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
        <!-- Pulsing Logo/Icon Center -->
        <div class="absolute inset-0 flex items-center justify-center">
             <i class="fas fa-chart-pie text-indigo-600/30 text-xl animate-pulse"></i>
        </div>
    </div>
    <div class="mt-4 text-center">
        <h3 class="text-lg font-bold text-slate-700 animate-pulse">Procesando Datos</h3>
        <p class="text-xs text-slate-400 font-medium">Analizando historial de producción...</p>
    </div>
</div>

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Hide loader immediately since we are serving SSR but we might want to keep it if we had async data.
    // However, since the user complained about delay BETWEEN page loads (when clicking 15 days),
    // we need to show it WHEN submitting the form.
    
    // Fade out on initial load
    setTimeout(() => {
        loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
    }, 300); // Small delay for smoothness

    // Re-show loader on form submit
    const filterForm = document.querySelector('form');
    if(filterForm) {
        filterForm.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            });
        });
    }

    // Full Screen Toggle
    const btnFs = document.getElementById('btnFullScreen');
    if(btnFs) {
        btnFs.addEventListener('click', () => {
             if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                btnFs.innerHTML = '<i class="fas fa-compress"></i><span class="hidden sm:inline">Salir</span>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    btnFs.innerHTML = '<i class="fas fa-expand"></i><span class="hidden sm:inline">Modo TV</span>';
                }
            }
        });
    }

    const chartData = {{ chart_json|safe }};
    
    // --- 1. OEE TREND CHART ---
    if (chartData.trend && chartData.trend.length > 0) {
        // Calculate Average for Header
        const totalOee = chartData.trend.reduce((acc, curr) => acc + curr.oee, 0);
        const avgOee = (totalOee / chartData.trend.length).toFixed(1);
        document.getElementById('avgOeeValue').textContent = avgOee + '%';

        const optionsOee = {
            series: [{
                name: 'OEE Global',
                data: chartData.trend.map(d => d.oee)
            }],
            chart: {
                type: 'area',
                height: 350,
                background: 'transparent',
                toolbar: { show: false },
                fontFamily: 'inherit',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                }
            },
            colors: ['#6366f1'], // Indigo 500
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.4,
                    opacityTo: 0.05,
                    stops: [0, 100]
                }
            },
            dataLabels: { enabled: false },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            xaxis: {
                categories: chartData.trend.map(d => d.date),
                axisBorder: { show: false },
                axisTicks: { show: false },
                labels: { style: { colors: '#94a3b8' } } // Slate 400
            },
            yaxis: {
                min: 0,
                max: 120, // Give some headroom above 100%
                labels: { 
                    style: { colors: '#94a3b8' },
                    formatter: function (value) { return value.toFixed(0) + "%"; }
                }
            },
            grid: {
                borderColor: '#e2e8f0', // Slate 200
                strokeDashArray: 4,
            },
            theme: { mode: 'light' },
            tooltip: {
                theme: 'light',
                y: { formatter: function (val) { return val + "%" } }
            }
        };

        const chartOee = new ApexCharts(document.querySelector("#chartOeeTrend"), optionsOee);
        chartOee.render();
    } else {
        document.querySelector("#chartOeeTrend").innerHTML = "<div class='h-full flex items-center justify-center text-slate-400'>Sin datos suficientes para tendencia</div>";
    }

    // --- 2. PARETO CHART (Standard Mixed Chart) ---
    if (chartData.pareto && chartData.pareto.labels && chartData.pareto.labels.length > 0) {
        
        const optionsPareto = {
            series: [
                {
                    name: 'Minutos Perdidos',
                    type: 'column',
                    data: chartData.pareto.values,
                    // Series-specific DataLabels for Bars (Simple Text)
                    dataLabels: {
                        enabled: true,
                        offsetY: -20,
                        style: {
                            fontSize: '11px',
                            fontWeight: 700,
                            colors: ['#334155']
                        },
                        background: { enabled: false },
                        formatter: function (val) {
                            const h = Math.floor(val / 60);
                            return h > 0 ? h + "h" : val + "m";
                        }
                    }
                },
                {
                    name: 'Acumulado %',
                    type: 'line',
                    data: chartData.pareto.cumulative,
                    // Series-specific DataLabels for Line (Badges)
                    dataLabels: {
                        enabled: true,
                        offsetY: -10,
                        style: {
                            fontSize: '10px',
                            fontWeight: 700,
                            colors: ['#ffffff']
                        },
                        background: {
                            enabled: true,
                            foreColor: '#fff',
                            borderRadius: 4,
                            padding: 4,
                            opacity: 0.9,
                            borderWidth: 0,
                            borderColor: '#fff'
                        },
                         formatter: function (val) {
                            return val + "%";
                        }
                    }
                }
            ],
            chart: {
                height: 350,
                type: 'line', 
                toolbar: { show: false },
                animations: { enabled: true, easing: 'easeinout', speed: 800 }
            },
            stroke: {
                width: [0, 4],
                curve: 'smooth'
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    columnWidth: '50%',
                    distributed: true
                }
            },
            colors: ['#3b82f6', '#f59e0b', '#10b981', '#f43f5e', '#8b5cf6', '#6366f1', '#ec4899', '#14b8a6'],
            
            // Global DataLabels (disabled here to use per-series, but kept for safety overrides)
            dataLabels: { enabled: false },
            
            labels: chartData.pareto.labels,
            xaxis: {
                labels: { 
                    style: { colors: '#64748b', fontSize: '10px' },
                    rotate: -45,
                    trim: true
                }
            },
            yaxis: [
                {
                    title: { text: 'Minutos', style: { color: '#3b82f6' } },
                    labels: { style: { colors: '#64748b' } }
                },
                {
                    opposite: true,
                    title: { text: 'Acumulado %', style: { color: '#334155' } },
                    min: 0,
                    max: 105, // Slightly above 100 for labels
                    labels: { style: { colors: '#64748b' } }
                }
            ],
            grid: {
                borderColor: '#e2e8f0',
                strokeDashArray: 4
            },
            theme: { mode: 'light' },
            legend: { show: false },
            tooltip: {
                shared: true,
                intersect: false,
                theme: 'light',
                y: [
                    {
                        formatter: function (val) {
                            if(typeof val === "undefined") return val;
                             const h = Math.floor(val / 60);
                             const m = Math.round(val % 60);
                             return h + " hs " + m + " min (" + val + " min)";
                        }
                    },
                    {
                        formatter: function (val) {
                            if(typeof val === "undefined") return val;
                            return val + " %";
                        }
                    }
                ]
            }
        };

        const chartPareto = new ApexCharts(document.querySelector("#chartPareto"), optionsPareto);
        chartPareto.render();
    } else {
        document.getElementById('chartPareto').style.display = 'none';
        document.getElementById('paretoEmpty').classList.remove('hidden');
        document.getElementById('paretoEmpty').classList.add('flex');
    }
});
</script>
{% endblock %}
