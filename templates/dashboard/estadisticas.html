{% extends 'base.html' %}

{% block title %}Estadísticas Avanzadas{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <!-- Top Bar & Filters -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
        <div>
            <h1 class="text-3xl font-black text-white flex items-center gap-4 uppercase tracking-tighter">
                <div class="w-14 h-14 rounded-2xl bg-amber-400 text-black flex items-center justify-center shadow-[0_0_20px_rgba(251,191,36,0.5)]">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                ANALÍTICAS
            </h1>
            <p class="text-slate-400 mt-2 font-black uppercase tracking-widest text-[10px]">Inteligencia Operativa & Predicción</p>
        </div>
        
        <!-- Actions -->
        <div class="flex items-center gap-4">
            <button id="btnFullScreen" class="px-5 py-2.5 bg-white/5 hover:bg-white/10 text-white rounded-xl font-black uppercase tracking-widest text-[10px] border border-white/10 transition-all flex items-center gap-2" title="Pantalla Completa">
                <i class="fas fa-expand text-amber-400"></i>
                <span class="hidden sm:inline">Modo Hub</span>
            </button>

            <!-- Date Selector -->
            <form method="get" class="flex bg-white/5 p-1.5 rounded-xl border border-white/5 shadow-inner">
                <button type="submit" name="period" value="7" class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all {% if period == 7 %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    07 Días
                </button>
                <button type="submit" name="period" value="15" class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all {% if period == 15 %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    15 Días
                </button>
                <button type="submit" name="period" value="30" class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all {% if period == 30 %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    30 Días
                </button>
            </form>
        </div>
    </div>

    <!-- OEE Trend Chart (HERO) -->
    <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden mb-8">
        <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
            <div>
                <h3 class="text-xs font-black text-slate-400 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,1)] animate-pulse"></span>
                    Evolución de Eficiencia Global (OEE)
                </h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Sincronización histórica en tiempo real</p>
            </div>
            <div class="text-right">
                <span class="block text-4xl font-black text-white font-tech tracking-tighter" id="avgOeeValue">--%</span>
                <span class="text-[9px] text-amber-400 font-black uppercase tracking-widest">PROMEDIO SECTORIAL</span>
            </div>
        </div>
        <div class="p-8 relative">
            <div id="chartOeeTrend" class="w-full h-[400px]"></div>
        </div>
    </div>

    <!-- INTELLIGENCE HUB -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Projection Card -->
        <div class="glass-card rounded-2xl p-6 border border-white/5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-bullseye text-5xl text-white"></i>
            </div>
            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4">Proyección Fin de Turno</h4>
            <div class="flex items-end gap-3">
                <span id="projectedValue" class="text-3xl font-black text-white font-tech tracking-tighter">--%</span>
                <div id="projectionTrend" class="mb-1 flex items-center gap-1 px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-500 text-[10px] font-black uppercase">
                    <i class="fas fa-caret-up"></i>
                    <span>Optimista</span>
                </div>
            </div>
            <p class="text-[9px] text-slate-400 font-bold mt-2 uppercase tracking-widest">Basado en ritmo operativo actual</p>
        </div>

        <!-- Goal Status Card -->
        <div class="glass-card rounded-2xl p-6 border border-white/5 relative overflow-hidden">
            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4">Meta Estándar (85% OEE)</h4>
            <div class="w-full bg-white/10 h-2.5 rounded-full overflow-hidden mb-3 border border-white/5">
                <div id="goalProgressBar" class="h-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)] transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[10px] font-black uppercase tracking-widest">
                <span class="text-slate-400">Progreso</span>
                <span id="goalPercentText" class="text-amber-400">0%</span>
            </div>
        </div>

        <!-- Reliability Card -->
        <div class="glass-card rounded-2xl p-6 border border-white/5">
            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4">Confiabilidad de Planta</h4>
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-center justify-center text-blue-400">
                    <i class="fas fa-shield-alt text-xl"></i>
                </div>
                <div>
                    <span class="block text-lg font-black text-white font-tech">94.2<span class="text-xs text-slate-400 ml-1">SR</span></span>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">MTBF / MTTR Index</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MIDDLE BI GRID: Bottlenecks & Sector Comparison -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Bottlenecks -->
        <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden flex flex-col">
            <div class="p-8 border-b border-white/5 bg-white/[0.02]">
                <h3 class="text-xs font-black text-slate-400 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                    <span class="w-1.5 h-1.5 rounded-full bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,1)]"></span>
                    Principales Cuellos de Botella
                </h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Impacto acumulado por detenciones</p>
            </div>
            <div class="p-6">
                <div id="bottleneckContainer" class="space-y-4">
                    <!-- Dynamic Bottlenecks -->
                </div>
            </div>
        </div>

        <!-- Sector Performance (Radar) -->
        <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden flex flex-col">
            <div class="p-8 border-b border-white/5 bg-white/[0.02]">
                <h3 class="text-xs font-black text-slate-400 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_10px_rgba(96,165,250,1)]"></span>
                    Desempeño por Sectores
                </h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Comparativa de Eficiencia Inter-Sectores</p>
            </div>
            <div class="p-4 flex-1 flex items-center justify-center">
                 <div id="chartSectors" class="w-full h-[350px]"></div>
            </div>
        </div>
    </div>

    <!-- PREDICTIVE MAINTENANCE HUB -->
    <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden mb-8">
        <div class="p-8 border-b border-white/5 bg-white/[0.02]">
            <h3 class="text-xs font-black text-slate-400 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                <span class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,1)] animate-pulse"></span>
                Mantenimiento Predictivo & Health Check
            </h3>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Estimación de vida útil basada en horas reales de uso</p>
        </div>
        <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
            <!-- Incident Heatmap -->
            <div>
                <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-6">Heatmap de Averías (30 Días)</h4>
                <div id="chartHeatmap" class="w-full h-[300px]"></div>
                <div id="heatmapEmpty" class="hidden h-[300px] items-center justify-center text-slate-600 text-[10px] uppercase font-bold tracking-widest">
                    Sin incidencias registradas en el periodo
                </div>
            </div>
            
            <!-- Service Life Meters -->
            <div>
                <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-6">Vida Útil del Cabezal / Service</h4>
                <div id="maintenanceMeters" class="space-y-6 max-h-[300px] overflow-y-auto pr-4 scrollbar-thin">
                    <!-- Dynamic Meters -->
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Pareto Chart (Downtime) -->
        <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden flex flex-col">
            <div class="p-8 border-b border-white/5 bg-white/[0.02]">
                <h3 class="text-xs font-black text-slate-500 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                    <span class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,1)]"></span>
                    Pareto de Detenciones Críticas
                </h3>
                <p class="text-[9px] text-slate-600 font-bold uppercase tracking-widest mt-1">Distribución de Tiempos Perdidos (Hs / Min)</p>
            </div>
            <div class="p-8 flex-1 flex items-center justify-center relative">
                 <div id="chartPareto" class="w-full h-[350px]"></div>
                 <!-- Empty State if no data -->
                 <div id="paretoEmpty" class="absolute inset-0 hidden flex flex-col items-center justify-center text-slate-500">
                    <i class="fas fa-check-circle text-4xl mb-3 text-emerald-500 opacity-20"></i>
                    <p class="font-black text-[10px] uppercase tracking-widest tracking-widest">Optimización de planta detectada</p>
                 </div>
            </div>
        </div>

        <!-- Ranking Table (Operators) -->
        <div class="glass-card rounded-2xl border border-white/5 shadow-2xl overflow-hidden flex flex-col">
             <div class="p-8 border-b border-white/5 bg-white/[0.02] flex justify-between items-center">
                <div>
                    <h3 class="text-xs font-black text-slate-500 mb-1 uppercase tracking-[0.3em] flex items-center gap-3">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_10px_rgba(96,165,250,1)]"></span>
                        Ranking de Productividad
                    </h3>
                    <p class="text-[9px] text-slate-600 font-bold uppercase tracking-widest mt-1">Liderazgo y performance operativa</p>
                </div>
                 <div class="w-12 h-12 rounded-2xl bg-amber-400/10 border border-amber-400/20 flex items-center justify-center text-amber-400 shadow-inner">
                    <i class="fas fa-trophy text-xl"></i>
                 </div>
            </div>
            <div class="overflow-y-auto max-h-[400px]">
                <table class="w-full">
                    <thead class="bg-white/[0.03] sticky top-0 z-10 border-b border-white/5">
                        <tr class="text-left text-[9px] uppercase tracking-[0.2em] text-slate-500 font-black">
                            <th class="px-8 py-5">#</th>
                            <th class="px-8 py-5">Operario</th>
                            <th class="px-8 py-5 text-center">Eficiencia</th>
                            <th class="px-8 py-5 text-right">Volumen</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for op in ranking_data %}
                        <tr class="hover:bg-white/[0.02] transition-all group border-b border-white/5 last:border-0">
                             <td class="px-8 py-5 font-mono text-slate-600 font-black text-[11px]">
                                {% if forloop.counter == 1 %}
                                    <i class="fas fa-medal text-amber-400 text-xl shadow-[0_0_15px_rgba(251,191,36,0.3)]"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="fas fa-medal text-slate-400 text-xl"></i>
                                {% elif forloop.counter == 3 %}
                                    <i class="fas fa-medal text-amber-900 text-xl"></i>
                                {% else %}
                                    {{ forloop.counter }}
                                {% endif %}
                             </td>
                             <td class="px-8 py-5">
                                <div class="font-black text-white group-hover:text-amber-400 transition-colors uppercase text-sm tracking-tighter">{{ op.name }}</div>
                                <div class="text-[9px] text-slate-600 font-tech font-bold tracking-widest uppercase">{{ op.legajo }}</div>
                             </td>
                             <td class="px-8 py-5 text-center">
                                <span class="px-4 py-1.5 rounded-xl text-[10px] font-black tracking-widest font-tech {% if op.oee >= 85 %}bg-emerald-400/10 text-emerald-400 border border-emerald-400/20{% elif op.oee >= 60 %}bg-amber-400/10 text-amber-400 border border-amber-400/20{% else %}bg-rose-400/10 text-rose-400 border border-rose-400/20{% endif %}">
                                    {{ op.oee }}%
                                </span>
                             </td>
                             <td class="px-8 py-5 text-right">
                                <span class="font-tech text-white font-black text-sm tracking-tighter">{{ op.total_qty|floatformat:0 }}</span>
                                <span class="text-[9px] text-slate-600 block font-black uppercase tracking-widest">unidades</span>
                             </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-8 py-20 text-center text-slate-600 text-[10px] font-black uppercase tracking-[0.2em] italic">
                                Sincronizando historial de producción...
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>


<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-[#020617]/95 backdrop-blur-xl z-[100] flex flex-col items-center justify-center transition-all duration-500">
    <div class="relative">
        <!-- Modern Spinner -->
        <div class="w-24 h-24 border-2 border-white/5 border-t-amber-400 rounded-full animate-spin"></div>
        <!-- Pulsing Center -->
        <div class="absolute inset-0 flex items-center justify-center">
             <div class="w-12 h-12 bg-amber-400/10 rounded-full flex items-center justify-center animate-pulse">
                <i class="fas fa-microchip text-amber-400"></i>
             </div>
        </div>
    </div>
    <div class="mt-8 text-center">
        <h3 class="text-xs font-black text-white uppercase tracking-[0.5em] animate-pulse">Procesando Análisis</h3>
        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-2">Sincronización de datos históricos...</p>
    </div>
</div>

<!-- Modal Detalle Día (PREMIUM) -->
<div id="modalDetalle" class="fixed inset-0 z-[110] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-[#020617]/90 backdrop-blur-xl"></div>
    
    <!-- Content Area -->
    <div class="absolute inset-0 flex items-center justify-center p-4 md:p-8">
        <div class="glass-card w-full max-w-6xl max-h-[90vh] overflow-hidden rounded-3xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)] flex flex-col scale-95 opacity-0 transition-all duration-300" id="modalContainer">
            <!-- Header -->
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                <div>
                     <h2 class="text-2xl md:text-3xl font-black text-white uppercase tracking-tighter flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-amber-400 text-black flex items-center justify-center shadow-lg">
                            <i class="fas fa-microchip"></i>
                        </div>
                        ANÁLISIS DE IMPACTO <span id="modalTitleDate" class="text-amber-400">--/--/----</span>
                     </h2>
                     <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.4em] mt-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        Diagnóstico Avanzado de Inteligencia Operativa
                     </p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 rounded-2xl bg-white/5 hover:bg-rose-500 hover:text-white text-slate-400 transition-all flex items-center justify-center border border-white/10 group">
                    <i class="fas fa-times text-xl group-hover:rotate-90 transition-transform"></i>
                </button>
            </div>
            
            <!-- Body -->
            <div class="p-8 overflow-y-auto custom-scrollbar">
                <!-- KPI Dashboard -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white/[0.03] p-6 rounded-3xl border border-white/5 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.07] transition-opacity">
                            <i class="fas fa-chart-line text-8xl text-white"></i>
                        </div>
                        <span class="text-[11px] font-black text-white uppercase tracking-widest block mb-1">OEE GLOBAL</span>
                        <div class="flex items-baseline gap-2">
                            <span id="modalGlobalOee" class="text-4xl font-black text-white font-tech tracking-tighter">--%</span>
                            <span class="text-[10px] font-black text-emerald-500">Real</span>
                        </div>
                    </div>
                    <div class="bg-white/[0.03] p-6 rounded-3xl border border-white/5 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.07] transition-opacity">
                            <i class="fas fa-clock text-8xl text-white"></i>
                        </div>
                        <span class="text-[11px] font-black text-white uppercase tracking-widest block mb-1">DISPONIBILIDAD</span>
                        <span id="modalAvail" class="text-4xl font-black text-amber-400 font-tech tracking-tighter">--%</span>
                    </div>
                    <div class="bg-white/[0.03] p-6 rounded-3xl border border-white/5 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.07] transition-opacity">
                            <i class="fas fa-tachometer-alt text-8xl text-white"></i>
                        </div>
                        <span class="text-[11px] font-black text-white uppercase tracking-widest block mb-1">RENDIMIENTO</span>
                        <span id="modalPerf" class="text-4xl font-black text-blue-400 font-tech tracking-tighter">--%</span>
                    </div>
                    <div class="bg-white/[0.03] p-6 rounded-3xl border border-white/5 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.07] transition-opacity">
                            <i class="fas fa-box text-8xl text-white"></i>
                        </div>
                        <span class="text-[11px] font-black text-white uppercase tracking-widest block mb-1">VOLUMEN TOTAL</span>
                        <div class="flex items-baseline gap-2">
                            <span id="modalUnits" class="text-4xl font-black text-white font-tech tracking-tighter">--</span>
                            <span class="text-[10px] font-black text-white/50 uppercase">uds</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <!-- Left: Machines -->
                    <div class="flex flex-col">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="text-xs font-black text-white uppercase tracking-[0.3em] flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,1)]"></span>
                                EFICIENCIA POR EQUIPO
                            </h4>
                            <span class="text-[10px] text-white/70 font-black uppercase tracking-widest">Sincronización ERP</span>
                        </div>
                        <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar" id="modalMachineList">
                             <!-- Dynamic Machines -->
                        </div>
                    </div>

                    <!-- Right: Downtime & Humans -->
                    <div class="space-y-10">
                        <!-- Pareto Modal -->
                         <div>
                            <div class="flex items-center justify-between mb-6">
                                <h4 class="text-xs font-black text-white uppercase tracking-[0.3em] flex items-center gap-3">
                                    <span class="w-2 h-2 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,1)]"></span>
                                    FUGAS DE PRODUCTIVIDAD (MINS)
                                </h4>
                            </div>
                            <div class="bg-white/[0.02] rounded-3xl p-6 border border-white/5 space-y-4" id="modalDowntimeList">
                                <!-- Dynamic Downtime -->
                            </div>
                         </div>
                         
                         <!-- Humans Top -->
                         <div>
                            <div class="flex items-center justify-between mb-6">
                                <h4 class="text-xs font-black text-white uppercase tracking-[0.3em] flex items-center gap-3">
                                    <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,1)]"></span>
                                    LIDERAZGO OPERATIVO
                                </h4>
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="modalOperatorList">
                                <!-- Dynamic Humans -->
                            </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
             <div class="p-8 border-t border-white/5 bg-white/[0.01] flex justify-between items-center">
                 <div class="flex gap-4">
                    <div class="flex items-center gap-2 text-[10px] font-black text-white/60 uppercase tracking-widest">
                        <i class="fas fa-shield-alt text-amber-400/50"></i>
                         Datos Certificados
                    </div>
                 </div>
                 <p class="text-[10px] text-white/40 font-black uppercase tracking-[0.3em]">PROCESADO POR MOTOR DE ANÁLISIS ABBAMAT</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Drill-down (LOGS) -->
<div id="modalLogs" class="fixed inset-0 z-[120] hidden">
    <div class="absolute inset-0 bg-[#020617]/95 backdrop-blur-2xl"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-4xl max-h-[85vh] rounded-3xl border border-white/20 shadow-2xl flex flex-col scale-95 opacity-0 transition-all duration-300" id="logsContainer">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/[0.02]">
                <div>
                     <h3 class="text-xl font-black text-white uppercase tracking-tighter flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-amber-400 text-black flex items-center justify-center">
                            <i class="fas fa-list-ul"></i>
                        </div>
                        DETALLES DE ACTIVIDAD: <span id="logsTitle" class="text-amber-400 ml-2">---</span>
                     </h3>
                </div>
                <button onclick="closeLogsModal()" class="w-10 h-10 rounded-xl bg-white/10 hover:bg-rose-500 text-white transition-all flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <table class="w-full text-left">
                    <thead class="text-[10px] font-black text-white uppercase tracking-widest border-b border-white/10">
                        <tr>
                            <th class="py-4 px-2">HORARIO</th>
                            <th class="py-4 px-2">ORDEN / ARTÍCULO</th>
                            <th class="py-4 px-2 text-right">CANT.</th>
                            <th class="py-4 px-2 text-right">REAL</th>
                            <th class="py-4 px-2 text-right">STD</th>
                            <th class="py-4 px-2">OBSERVACIONES</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody" class="divide-y divide-white/5">
                        <!-- Dynamic Logs -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart Data JSON -->
<script id="analytics-data" type="application/json">{{ chart_json|safe }}</script>

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
function closeModal() {
    const modal = document.getElementById('modalDetalle');
    const container = document.getElementById('modalContainer');
    container.classList.remove('scale-100', 'opacity-100');
    container.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function closeLogsModal() {
    const modal = document.getElementById('modalLogs');
    const container = document.getElementById('logsContainer');
    container.classList.remove('scale-100', 'opacity-100');
    container.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

let lastFetchedData = null;

function showLogs(type, id) {
    if (!lastFetchedData) return;
    
    let logs = [];
    let title = "";
    
    if (type === 'machine') {
        const m = lastFetchedData.machines.find(x => x.id === id);
        if (m) {
            logs = m.logs;
            title = m.name;
        }
    } else {
        const o = lastFetchedData.operators.find(x => x.uid === id);
        if (o) {
            logs = o.logs;
            title = o.name;
        }
    }

    const tbody = document.getElementById('logsTableBody');
    document.getElementById('logsTitle').textContent = title;
    
    tbody.innerHTML = logs.map(l => `
        <tr class="hover:bg-white/[0.02] transition-colors ${l.is_stop ? 'bg-rose-500/5' : ''}">
            <td class="py-4 px-2 font-tech text-xs text-white">${l.time}</td>
            <td class="py-4 px-2">
                <div class="text-[10px] font-black text-amber-400 uppercase">${l.order}</div>
                <div class="text-[9px] font-bold text-white uppercase">${l.article}</div>
            </td>
            <td class="py-4 px-2 text-right font-tech text-xs text-white">${l.qty}</td>
            <td class="py-4 px-2 text-right font-tech text-xs ${l.is_stop ? 'text-rose-400' : 'text-blue-400'}">${l.mins}m</td>
            <td class="py-4 px-2 text-right font-tech text-xs text-emerald-400">${l.std}m</td>
            <td class="py-4 px-2 text-[10px] text-slate-300 font-medium italic">${l.obs}</td>
        </tr>
    `).join('');

    const modal = document.getElementById('modalLogs');
    const container = document.getElementById('logsContainer');
    modal.classList.remove('hidden');
    setTimeout(() => {
        container.classList.remove('scale-95', 'opacity-0');
        container.classList.add('scale-100', 'opacity-100');
    }, 50);
}

async function openDetailsModal(date) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
    
    try {
        const response = await fetch(`/dashboard/api/detalle-oee-dia/?date=${date}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        lastFetchedData = data;

        // Populate Modal
        document.getElementById('modalTitleDate').textContent = data.date;
        document.getElementById('modalGlobalOee').textContent = data.global.oee + '%';
        document.getElementById('modalAvail').textContent = data.global.availability + '%';
        document.getElementById('modalPerf').textContent = data.global.performance + '%';
        document.getElementById('modalUnits').textContent = data.global.units.toLocaleString();

        // Machine List
        const mList = document.getElementById('modalMachineList');
        mList.innerHTML = data.machines.map(m => `
            <div onclick="showLogs('machine', '${m.id}')" class="p-5 rounded-3xl bg-white/[0.02] border border-white/5 hover:bg-white/[0.04] transition-all group cursor-pointer active:scale-95">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-2xl bg-white/5 flex items-center justify-center text-slate-400 group-hover:text-amber-400 transition-colors">
                            <i class="fas fa-industry"></i>
                        </div>
                        <div>
                            <span class="text-[11px] font-black text-white uppercase tracking-tighter block">${m.name}</span>
                            <span class="text-[9px] font-bold text-white/40 uppercase tracking-widest">${m.id}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-black text-white font-tech">${m.oee}%</span>
                        <span class="block text-[8px] text-white/50 font-black uppercase">OEE Máquina</span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-4 pt-4 border-t border-white/5">
                    <div class="text-center">
                        <span class="block text-[10px] font-bold text-white uppercase mb-1">Unidades</span>
                        <span class="text-xs font-black text-white">${m.qty}</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-[10px] font-bold text-white uppercase mb-1">Paradas</span>
                        <span class="text-xs font-black text-rose-500">${m.lost_mins}m</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-[10px] font-bold text-white uppercase mb-1">STD</span>
                        <span class="text-xs font-black text-emerald-400">${m.std_mins}m</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-[10px] font-bold text-white uppercase mb-1">Perf.</span>
                        <span class="text-xs font-black text-blue-400">${m.perf}%</span>
                    </div>
                </div>
            </div>
        `).join('');

        // Downtime List
        const dList = document.getElementById('modalDowntimeList');
        dList.innerHTML = data.downtime.length > 0 ? data.downtime.map(d => `
            <div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                <span class="text-[11px] font-black text-white uppercase tracking-tighter">${d.reason}</span>
                <span class="text-[11px] font-tech text-rose-400 font-bold">${d.mins} min</span>
            </div>
        `).join('') : '<p class="text-[10px] text-slate-600 italic uppercase">Sin registros de paradas</p>';

        // Operator List
        const oList = document.getElementById('modalOperatorList');
        oList.innerHTML = data.operators.map(o => `
            <div onclick="showLogs('operator', '${o.uid}')" class="flex justify-between items-center p-4 rounded-2xl bg-white/[0.02] border border-white/5 hover:bg-white/[0.04] transition-all group cursor-pointer active:scale-95">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-xl bg-blue-500/10 text-blue-400 flex items-center justify-center text-[10px]">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="text-[11px] font-black text-white uppercase tracking-tighter">${o.name}</span>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <span class="block text-[9px] font-black text-white/50 uppercase">Eficiencia</span>
                        <span class="text-[10px] font-black text-emerald-400 font-tech">${o.perf}%</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-[9px] font-black text-white/50 uppercase">Producción</span>
                        <span class="text-[10px] font-black text-white font-tech">${o.qty}</span>
                    </div>
                </div>
            </div>
        `).join('');

        // Show Modal
        const modal = document.getElementById('modalDetalle');
        const container = document.getElementById('modalContainer');
        modal.classList.remove('hidden');
        setTimeout(() => {
            container.classList.remove('scale-95', 'opacity-0');
            container.classList.add('scale-100', 'opacity-100');
        }, 50);

    } catch (err) {
        console.error(err);
        alert("Error al cargar detalles: " + err.message);
    } finally {
        loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Fade out on initial load
    setTimeout(() => {
        loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
    }, 300);

    // Filter form loader
    const filterForm = document.querySelector('form');
    if(filterForm) {
        filterForm.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            });
        });
    }

    // Full screen
    const btnFs = document.getElementById('btnFullScreen');
    if(btnFs) {
        btnFs.addEventListener('click', () => {
             if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        });
    }

    const chartData = JSON.parse(document.getElementById('analytics-data').textContent);
    
    // --- 1. OEE TREND CHART ---
    if (chartData.trend && chartData.trend.length > 0) {
        const totalOee = chartData.trend.reduce((acc, curr) => acc + curr.oee, 0);
        const avgOee = (totalOee / chartData.trend.length).toFixed(1);
        document.getElementById('avgOeeValue').textContent = avgOee + '%';

        const optionsOee = {
            series: [{ name: 'OEE Global', data: chartData.trend.map(d => d.oee) }],
            chart: { 
                type: 'area', 
                height: 400, 
                background: 'transparent', 
                toolbar: { show: false }, 
                fontFamily: 'JetBrains Mono',
                events: {
                    markerClick: function(event, chartContext, { seriesIndex, dataPointIndex, config }) {
                        const dayData = chartData.trend[dataPointIndex];
                        if (dayData && dayData.full_date) {
                            openDetailsModal(dayData.full_date);
                        }
                    }
                }
            },
            colors: ['#fbbf24'],
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.05, stops: [0, 100] } },
            stroke: { curve: 'smooth', width: 4 },
            xaxis: { 
                categories: chartData.trend.map(d => d.date), 
                labels: { style: { colors: '#ffffff', fontWeight: 700 } } 
            },
            yaxis: { 
                min: 0, 
                max: 110, 
                labels: { style: { colors: '#ffffff', fontWeight: 700 }, formatter: v => v.toFixed(0) + "%" } 
            },
            grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 8 },
            markers: {
                size: 6,
                colors: ['#0f172a'],
                strokeColors: '#fbbf24',
                strokeWidth: 3,
                hover: { size: 9, sizeOffset: 3 }
            },
            theme: { mode: 'dark' },
            tooltip: {
                theme: 'dark',
                y: { formatter: v => v + "%" },
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    return '<div class="px-3 py-2 bg-slate-900 border border-white/10 rounded-lg shadow-xl">' +
                        '<span class="block text-[10px] font-black text-slate-500 uppercase tracking-widest">' + w.globals.labels[dataPointIndex] + '</span>' +
                        '<span class="text-lg font-black text-white">' + series[seriesIndex][dataPointIndex] + '%</span>' +
                        '<span class="block text-[8px] font-bold text-amber-400 uppercase mt-1">Presione para ver detalle</span>' +
                        '</div>';
                }
            }
        };
        new ApexCharts(document.querySelector("#chartOeeTrend"), optionsOee).render();
    }

    // --- 2. PARETO CHART ---
    if (chartData.pareto && chartData.pareto.labels && chartData.pareto.labels.length > 0) {
        const optionsPareto = {
            series: [
                { name: 'Minutos Perdidos', type: 'column', data: chartData.pareto.values },
                { name: 'Acumulado %', type: 'line', data: chartData.pareto.cumulative }
            ],
            chart: { height: 350, type: 'line', toolbar: { show: false }, fontFamily: 'JetBrains Mono' },
            stroke: { width: [0, 4], curve: 'smooth' },
            colors: ['#3b82f6', '#f59e0b', '#10b981', '#f43f5e', '#8b5cf6'],
            labels: chartData.pareto.labels,
            yaxis: [
                { title: { text: 'MINUTOS', style: { color: '#94a3b8' } }, labels: { style: { colors: '#ffffff' } } },
                { opposite: true, title: { text: 'ACUMULADO %', style: { color: '#94a3b8' } }, min: 0, max: 105, labels: { style: { colors: '#ffffff' } } }
            ],
            theme: { mode: 'dark' },
            legend: { show: false }
        };
        new ApexCharts(document.querySelector("#chartPareto"), optionsPareto).render();
    } else {
        const pChart = document.getElementById('chartPareto');
        if(pChart) pChart.style.display = 'none';
        const pEmpty = document.getElementById('paretoEmpty');
        if(pEmpty) pEmpty.classList.replace('hidden', 'flex');
    }

    // --- 3. BI INTELLIGENCE ---
    if (chartData.projection) {
        const pVal = document.getElementById('projectedValue');
        if(pVal) pVal.textContent = chartData.projection.projected + '%';
        const progress = Math.min(100, (chartData.projection.current / 85) * 100);
        setTimeout(() => {
            const bar = document.getElementById('goalProgressBar');
            if(bar) bar.style.width = progress + '%';
            const text = document.getElementById('goalPercentText');
            if(text) text.textContent = Math.round(progress) + '%';
        }, 500);
        
        const trendEl = document.getElementById('projectionTrend');
        if (trendEl) {
            if (chartData.projection.trend === 'down') {
                trendEl.className = "mb-1 flex items-center gap-1 px-1.5 py-0.5 rounded bg-rose-500/10 text-rose-500 text-[10px] font-black uppercase";
                trendEl.innerHTML = '<i class="fas fa-caret-down"></i><span>Decreciente</span>';
            } else if (chartData.projection.trend === 'stable') {
                trendEl.className = "mb-1 flex items-center gap-1 px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-500 text-[10px] font-black uppercase";
                trendEl.innerHTML = '<i class="fas fa-minus"></i><span>Estable</span>';
            }
        }
    }

    // --- 4. BOTTLENECKS ---
    if (chartData.bottlenecks && chartData.bottlenecks.length > 0) {
        const bCont = document.getElementById('bottleneckContainer');
        if(bCont) {
            bCont.innerHTML = chartData.bottlenecks.map(m => `
                <div class="p-4 rounded-xl bg-white/[0.02] border border-white/5 hover:bg-white/[0.04] transition-all">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[11px] font-black text-white uppercase tracking-tighter">${m.name}</span>
                        <span class="text-[9px] font-tech font-bold text-rose-400">${m.lost_mins} Min Perdidos</span>
                    </div>
                    <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                        <div class="h-full bg-rose-500" style="width: ${m.impact}%"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // --- 5. SECTOR RADAR ---
    if (chartData.sector_ranking && chartData.sector_ranking.length > 0) {
        const optionsSector = {
            series: [{ name: 'Eficiencia %', data: chartData.sector_ranking.map(s => s.efficiency) }],
            chart: { height: 350, type: 'radar', toolbar: { show: false }, background: 'transparent', fontFamily: 'JetBrains Mono' },
            colors: ['#fbbf24'],
            labels: chartData.sector_ranking.map(s => s.sector),
            xaxis: { labels: { style: { colors: '#ffffff', fontSize: '9px', fontWeight: 800 } } },
            yaxis: { show: false, min: 0, max: 100 },
            theme: { mode: 'dark' }
        };
        new ApexCharts(document.querySelector("#chartSectors"), optionsSector).render();
    }

    // --- 6. HEATMAP ---
    if (chartData.heatmap && chartData.heatmap.length > 0) {
        const optionsHeatmap = {
            series: chartData.heatmap,
            chart: { height: 300, type: 'heatmap', toolbar: { show: false }, background: 'transparent', fontFamily: 'JetBrains Mono' },
            plotOptions: { heatmap: { shadeIntensity: 0.5, radius: 4, useFillColorAsStroke: true, colorScale: { ranges: [{ from: 1, to: 2, name: 'Bajo', color: '#fb7185' }, { from: 3, to: 5, name: 'Medio', color: '#e11d48' }, { from: 6, to: 100, name: 'Crítico', color: '#9f1239' }] } } },
            xaxis: { labels: { style: { colors: '#ffffff', fontSize: '10px' } } },
            theme: { mode: 'dark' }
        };
        new ApexCharts(document.querySelector("#chartHeatmap"), optionsHeatmap).render();
    }

    // --- 7. MAINTENANCE ---
    if (chartData.maintenance && chartData.maintenance.length > 0) {
        const mCont = document.getElementById('maintenanceMeters');
        if(mCont) {
            mCont.innerHTML = chartData.maintenance.map(m => `
                <div class="group">
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-[10px] font-black text-white uppercase tracking-tighter">${m.name}</span>
                        <span class="text-[9px] font-tech font-bold ${m.progreso > 80 ? 'text-rose-400' : 'text-amber-400'}">${m.horas_uso} / ${m.frecuencia} hs</span>
                    </div>
                    <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden border border-white/5 shadow-inner">
                        <div class="h-full bg-gradient-to-r ${m.progreso > 80 ? 'from-rose-600 to-rose-400' : 'from-amber-600 to-amber-400'}" style="width: ${m.progreso}%"></div>
                    </div>
                </div>
            `).join('');
        }
    }
});
</script>
{% endblock %}
