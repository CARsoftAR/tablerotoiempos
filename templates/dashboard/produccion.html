{% extends 'base.html' %}
{% load l10n %}

{% block title %}Tablero de Producción - OEE{% endblock %}

{% block content %}
<!-- Premium Tooltip CSS -->
<style>
    .smart-popover {
        position: fixed;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 320px;
    }
    .smart-popover.active {
        opacity: 1;
        transform: translateY(0);
    }
    .report-main-title {
        display: block;
        font-size: 1.25rem;
        font-weight: 900;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: -0.025em;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 0.5rem;
    }
    .glass-card {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5), 0 8px 10px -6px rgb(0 0 0 / 0.5);
    }
    .explain-trigger {
        cursor: help;
        border-bottom: 1px dotted rgba(255,255,255,0.2);
    }
    .explain-trigger:hover {
        border-bottom-color: #3b82f6;
        color: #fff;
    }

    /* Fixed Header Positioning - Compensate for base layout padding */
    .sticky-header-container {
        position: sticky;
        top: -16px; /* p-4 in base.html */
        z-index: 50;
        background-color: #020617; /* Matches base bg */
        margin: -16px -16px 24px -16px;
        padding: 16px 16px 0 16px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    @media (min-width: 768px) {
        .sticky-header-container {
            top: -32px; /* md:p-8 in base.html */
            margin: -32px -32px 24px -32px;
            padding: 32px 32px 0 32px;
        }
    }
    /* Icon Pulse Animation */
    @keyframes icon-pulse {
        0% { transform: scale(1); filter: brightness(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        50% { transform: scale(1.08); filter: brightness(1.4); }
        100% { transform: scale(1); filter: brightness(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }
    .animate-icon-pulse {
        animation: icon-pulse 2s infinite ease-in-out;
    }
</style>

<div id="global-popover" class="smart-popover glass-card rounded-xl p-4 hidden">
    <div class="flex items-center gap-3 mb-2 border-b border-slate-700/50 pb-2">
        <div id="popover-icon" class="w-8 h-8 rounded-lg flex items-center justify-center text-white bg-blue-600">
            <i class="fas fa-info-circle"></i>
        </div>
        <h4 id="popover-title" class="font-bold text-white text-sm uppercase tracking-wider">Detalle del Valor</h4>
    </div>
    <p id="popover-text" class="text-slate-300 text-[13px] leading-relaxed"></p>
    <div class="mt-3 pt-2 border-t border-slate-700/50 text-[10px] text-slate-500 font-bold uppercase flex justify-between">
        <span>DATOS DEL SISTEMA</span>
        <span id="popover-calc-type">Cálculo Automático</span>
    </div>
</div>

<!-- 1. UNIFIED STICKY HEADER (OEE + FILTERS + TABS) -->
<div class="sticky-header-container">
    
    <!-- A. OVERALL OEE PANEL -->
    {% localize off %}
    <div class="glass-card rounded-2xl overflow-hidden border border-white/10 mb-5">
        <!-- Header Premium -->
        <div class="bg-white/5 px-8 py-5 flex justify-between items-center border-b border-white/5">
            <h2 class="text-white font-black text-xs tracking-[0.2em] uppercase flex items-center gap-3">
                <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse shadow-[0_0_10px_rgba(251,191,36,1)]"></span>
                SISTEMA OEE GLOBAL <span class="text-amber-400 ml-2">({{ resumen_activo.promedio_oee }}%)</span>
            </h2>
            <div class="flex gap-4 items-center">
                <div class="flex gap-3 text-slate-400 text-[10px] font-bold tracking-widest uppercase bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                    <i class="fas fa-calendar-day text-amber-400"></i> 
                    <span>
                        {% if is_range %}{{ fecha_target|date:"d M" }} - {{ fecha_fin_target|date:"d M Y" }}{% else %}{{ fecha_target|date:"d M Y" }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Gauges Row -->
        <div class="px-10 py-8 grid grid-cols-1 md:grid-cols-3 gap-12 text-center text-white bg-gradient-to-b from-transparent to-white/[0.02]">
            <!-- Availability Gauge -->
            <div class="flex flex-col items-center group">
                <div class="relative w-44 h-[5.5rem] overflow-hidden mb-2">
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-white/5 box-border"></div>
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-amber-400 box-border origin-center shadow-[0_0_20px_rgba(251,191,36,0.3)]" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_availability > 100 %}100{% else %}{{ resumen_activo.avg_availability }}{% endif %} - 180deg));"></div> 
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-3xl font-black text-white font-tech">{{ resumen_activo.avg_availability }}<span class="text-xs text-slate-500 ml-1">%</span></span>
                    </div>
                </div>
                <span class="text-slate-400 font-extrabold uppercase tracking-[0.3em] text-[8px] group-hover:text-amber-400 transition-colors">Disponibilidad</span>
            </div>

            <!-- Performance Gauge -->
            <div class="flex flex-col items-center group">
                <div class="relative w-44 h-[5.5rem] overflow-hidden mb-2">
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-white/5 box-border"></div>
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-blue-400 box-border origin-center shadow-[0_0_20px_rgba(96,165,250,0.3)]" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_performance > 100 %}100{% else %}{{ resumen_activo.avg_performance }}{% endif %} - 180deg));"></div>
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-3xl font-black text-white font-tech">{{ resumen_activo.avg_performance }}<span class="text-xs text-slate-500 ml-1">%</span></span>
                    </div>
                </div>
                <span class="text-slate-400 font-extrabold uppercase tracking-[0.3em] text-[8px] group-hover:text-blue-400 transition-colors">Rendimiento</span>
            </div>

            <!-- Quality Gauge -->
            <div class="flex flex-col items-center group">
                <div class="relative w-44 h-[5.5rem] overflow-hidden mb-2">
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-white/5 box-border"></div>
                    <div class="absolute w-44 h-44 rounded-full border-[10px] border-emerald-400 box-border origin-center shadow-[0_0_20px_rgba(52,211,153,0.3)]" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_quality > 100 %}100{% else %}{{ resumen_activo.avg_quality }}{% endif %} - 180deg));"></div>
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-3xl font-black text-white font-tech">{{ resumen_activo.avg_quality }}<span class="text-xs text-slate-500 ml-1">%</span></span>
                    </div>
                </div>
                <span class="text-slate-400 font-extrabold uppercase tracking-[0.3em] text-[8px] group-hover:text-emerald-400 transition-colors">Calidad</span>
            </div>
        </div>
    </div>
    {% endlocalize %}

    <!-- B. DATE NAVIGATION & PERSPECTIVE (Oculto en TV) -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 {% if is_tv_mode %}hidden{% endif %}">
        <div class="flex items-center gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Visualización de Datos</h1>
            <div class="flex bg-white/5 p-1 rounded-xl border border-white/5 shadow-inner overflow-hidden">
                <a href="?view=machines&{% if is_range %}start_date={{ fecha_target|date:'Y-m-d' }}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% else %}date={{ fecha_target|date:'Y-m-d' }}{% endif %}" 
                    class="px-5 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if view_type == 'machines' %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-microchip"></i> Máquinas
                </a>
                <a href="?view=personnel&{% if is_range %}start_date={{ fecha_target|date:'Y-m-d' }}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% else %}date={{ fecha_target|date:'Y-m-d' }}{% endif %}" 
                    class="px-5 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if view_type == 'personnel' %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-users"></i> Personal
                </a>
            </div>
        </div>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
            <div class="flex bg-white/5 p-1 rounded-xl border border-white/5 shadow-inner">
                <a href="?date=today" class="px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if is_today and not is_range %}bg-blue-500 text-white shadow-[0_0_15px_rgba(59,130,246,0.5)]{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-calendar-day"></i> Hoy
                </a>
                <a href="?date=yesterday" class="px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if not is_today and not is_range %}bg-white/10 text-white shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-history"></i> Ayer
                </a>
                <div class="relative">
                    <button onclick="document.getElementById('range-form').classList.toggle('hidden')" class="px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if is_range %}bg-indigo-500 text-white shadow-[0_0_15px_rgba(99,102,241,0.5)]{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                        <i class="fas fa-calendar-alt"></i> Intervalo
                    </button>
                    <div id="range-form" class="hidden absolute right-0 mt-3 glass-panel p-5 rounded-2xl shadow-3xl border border-white/10 z-[100] w-72">
                        <form method="GET" class="space-y-4">
                            <input type="hidden" name="view" value="{{ view_type }}">
                            <div>
                                <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-2">Desde</label>
                                <input type="date" name="start_date" value="{{ fecha_target|date:'Y-m-d' }}" class="w-full bg-[#020617] border-white/10 rounded-xl text-white text-xs p-2.5 focus:border-amber-400 transition-colors">
                            </div>
                            <div>
                                <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-2">Hasta</label>
                                <input type="date" name="end_date" value="{{ fecha_fin_target|date:'Y-m-d' }}" class="w-full bg-[#020617] border-white/10 rounded-xl text-white text-xs p-2.5 focus:border-amber-400 transition-colors">
                            </div>
                            <button type="submit" class="w-full bg-amber-400 text-black py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-white transition-all shadow-lg active:scale-95">
                                Aplicar Filtro
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="flex bg-white/5 p-1 rounded-xl border border-white/5 shadow-inner">
                <a href="?format=clock" class="px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if time_format == 'clock' %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-clock"></i> Reloj
                </a>
                <a href="?format=decimal" class="px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if time_format == 'decimal' %}bg-amber-400 text-black shadow-lg{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-calculator"></i> Decimal
                </a>
            </div>

            <!-- TV Mode Toggle -->
            <a href="?mode={% if is_tv_mode %}normal{% else %}tv{% endif %}" class="px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 {% if is_tv_mode %}bg-emerald-500 text-white shadow-[0_0_15px_rgba(16,185,129,0.5)] animate-pulse{% else %}bg-white/5 text-slate-400 hover:text-white border border-white/5{% endif %}">
                <i class="fas fa-desktop"></i> MODO TV
            </a>
            
            <!-- Full Screen Toggle -->
            <button id="btnFullScreen" class="px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest bg-violet-600 text-white hover:bg-violet-500 transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(124,58,237,0.3)]">
                <i class="fas fa-expand"></i> <span class="hidden sm:inline">PANTALLA</span>
            </button>

            <!-- TTS Audio Toggle -->
            <button id="btnAudio" onclick="enableAudioContext()" class="w-10 h-10 rounded-xl bg-white/5 border border-white/5 text-slate-400 flex items-center justify-center hover:bg-white hover:text-black transition-all">
                <i class="fas fa-volume-mute"></i>
            </button>

            <a href="{% url 'generar_reporte_pdf' %}{% if is_range %}?start_date={{ fecha_target|date:'Y-m-d' }}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% else %}?date={{ fecha_target|date:'Y-m-d' }}{% endif %}" 
               target="_blank"
               class="px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest bg-rose-600 text-white hover:bg-rose-500 transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(225,29,72,0.3)]">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
        </div>
    </div>

    <!-- C. TABS Selector (Oculto en TV porque rotan solas) -->
    <div class="flex border-b border-white/5 gap-4 {% if is_tv_mode %}hidden{% endif %}">
        <button onclick="switchTab('tab-global')" id="btn-tab-global" 
            class="px-8 py-4 font-black text-[10px] uppercase tracking-[0.2em] transition-all border-b-2 border-amber-400 text-amber-400">
            Resumen General
        </button>
        <button onclick="switchTab('tab-detalle')" id="btn-tab-detalle" 
            class="px-8 py-4 font-black text-[10px] uppercase tracking-[0.2em] transition-all border-b-2 border-transparent text-slate-400 hover:text-white">
            Monitoreo Individual
        </button>
    </div>
</div>

{% if is_tv_mode %}
<!-- Exit TV Mode Button -->
<a href="?mode=normal" 
   class="fixed bottom-6 right-24 z-[9999] w-14 h-14 bg-red-600/80 hover:bg-red-500 text-white rounded-full shadow-[0_0_20px_rgba(220,38,38,0.5)] flex items-center justify-center transition-all backdrop-blur-md border border-white/20 hover:scale-110 active:scale-95 group"
   title="Salir de Modo TV">
    <i class="fas fa-door-open text-xl drop-shadow-md"></i>
</a>

<!-- Floating Fullscreen Toggle Button for TV Mode -->
<button id="tv-fullscreen-toggle" 
        class="fixed bottom-6 right-6 z-[9999] w-14 h-14 bg-blue-600/80 hover:bg-blue-500 text-white rounded-full shadow-[0_0_20px_rgba(37,99,235,0.5)] flex items-center justify-center transition-all backdrop-blur-md border border-white/20 hover:scale-110 active:scale-95 group"
        title="Pantalla Completa / Ventana">
    <i class="fas fa-expand text-xl drop-shadow-md"></i>
</button>
{% endif %}

<div id="tab-global" class="tab-content space-y-6">
    <!-- C. GRÁFICOS AVANZADOS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gráfico de Tendencia -->
        <div class="bg-slate-800 rounded-lg p-5 border border-slate-700 shadow-xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-chart-line text-6xl text-blue-500"></i>
            </div>
            <h3 class="text-white font-bold text-sm mb-4 flex items-center gap-2 relative z-10 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                Evolución OEE (7 Días)
            </h3>
            <div id="chart-trend" class="h-56 relative z-10 w-full"></div>
        </div>
        <!-- Pareto de Paradas -->
        <div class="bg-slate-800 rounded-lg p-5 border border-slate-700 shadow-xl relative overflow-hidden group">
             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-clock text-6xl text-amber-500"></i>
            </div>
            <h3 class="text-white font-bold text-sm mb-4 flex items-center gap-2 relative z-10 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                Pareto de Paradas (Hs / Motivo)
            </h3>
            <div id="chart-pareto" class="h-56 relative z-10 w-full"></div>
        </div>
    </div>

    <!-- Detailed Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Availability Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-teal-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Disponibilidad</span>
                <span class="text-white/90">{{ resumen_activo.avg_availability }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Esperado</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_planned_formatted }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_formatted }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-teal-400 shadow-[0_0_10px_rgba(45,212,191,0.5)] transition-all duration-1000" style="width: {{ resumen_activo.avg_availability }}%"></div>
                </div>
            </div>
        </div>

        <!-- Performance Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-lime-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Rendimiento</span>
                <span class="text-white/90">{{ resumen_activo.avg_performance }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">T. Estándar</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_standard_formatted }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-lime-400 shadow-[0_0_10px_rgba(163,230,53,0.5)] transition-all duration-1000" style="width: {% if resumen_activo.avg_performance > 100 %}100{% else %}{{ resumen_activo.avg_performance }}{% endif %}%"></div>
                </div>
            </div>
        </div>

        <!-- Quality Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-amber-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Calidad</span>
                <span class="text-white/90">{{ resumen_activo.avg_quality }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Reproceso</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_rejected_qty }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)] transition-all duration-1000" style="width: {{ resumen_activo.avg_quality }}%"></div>
                </div>
            </div>
        </div>

        <!-- Active Count Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-indigo-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Estado Operativo</span>
                <span class="text-white/90">{{ resumen_activo.promedio_oee }}% OEE</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Activos</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.active_count }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Piezas Totales</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_total_qty }}</span>
                </div>
                {% if is_today %}
                <div class="pt-4 border-t border-slate-700/30">
                    <span class="flex items-center gap-1.5 text-emerald-400 text-[10px] font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        DATOS EN VIVO
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Unassigned Card (Solo en vista máquinas para ver qué falta configurar) -->
        {% if view_type == 'machines' %}
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl border-t-amber-500/50 border-t-2">
            <div class="bg-amber-600/20 px-4 py-2 font-bold text-amber-500 tracking-wide flex justify-between items-center text-sm">
                <span>Sin Asignar</span>
                <span class="text-amber-500/90 italic text-[10px]">Fuera de Dashboard</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase">Piezas sin máquina</span>
                    </div>
                    <span class="text-white font-bold text-lg">{{ resumen.unassigned_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-sm font-medium">Tiempo Total</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase">Maquinas inactivas</span>
                    </div>
                    <span class="text-white font-bold text-lg">{{ resumen.unassigned_time_formatted }}</span>
                </div>
                <div class="pt-4 border-t border-slate-700/30 flex justify-between items-center">
                    <span class="text-amber-500/80 text-[10px] font-bold uppercase tracking-tighter">
                        <i class="fas fa-exclamation-circle mr-1"></i> Requiere Config.
                    </span>
                    <a href="{% url 'gestion_maquinas' %}" class="text-[9px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 px-2 py-1 rounded border border-amber-500/20 transition-all font-black">EDITAR</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div id="tab-detalle" class="tab-content hidden space-y-10">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {% for item in cards_data %}
        <div class="glass-card rounded-2xl overflow-hidden border border-white/5 hover:border-amber-400/50 transition-all duration-500 shadow-2xl group relative translate-y-0 hover:-translate-y-2">
            <!-- ALERTA INACTIVIDAD MODO TV -->
            {% if is_tv_mode and item.idle_mins > 30 and is_today %}
                <div class="absolute inset-0 bg-red-600/5 animate-pulse pointer-events-none z-[5]"></div>
                <div class="absolute top-0 right-0 p-3 z-[20]">
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 shadow-[0_0_15px_rgba(239,68,68,1)]"></span>
                </div>
            {% endif %}

             <!-- Header Card 2.0 -->
             <div class="bg-white/[0.03] px-6 py-5 border-b border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-white/5 flex items-center justify-center text-slate-400 group-hover:bg-amber-400 group-hover:text-black transition-all shadow-inner">
                        <i class="fas {% if view_type == 'personnel' %}fa-user{% else %}fa-microchip{% endif %} text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-black text-sm uppercase tracking-tighter group-hover:text-amber-400 transition-colors">{{ item.name }}</h3>
                        <p class="text-[9px] text-slate-300 font-tech font-bold uppercase tracking-widest mt-0.5">
                            {% if view_type == 'personnel' %}{{ item.last_machine|default:item.id }}{% else %}{{ item.operator_name|default:item.id }}{% endif %}
                        </p>
                    </div>
                </div>
                <button onclick="openIndividualAudit('{{ item.id }}', '{{ item.name|escapejs }}', 'analysis')" 
                        class="w-9 h-9 rounded-xl bg-white/5 border border-white/5 text-slate-500 flex items-center justify-center hover:bg-amber-400 hover:text-black transition-all">
                    <i class="fas fa-terminal text-xs"></i>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <!-- Status Row 2.0 -->
                <div class="flex justify-between items-center bg-white/5 rounded-xl px-4 py-3 border border-white/5">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Estado Actual</span>
                        <span class="text-[10px] font-bold text-amber-400 italic truncate max-w-[140px]">{{ item.last_reason|default:"TERMINADO" }}</span>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">OEE</span>
                        <span class="text-xl font-black text-white font-tech tracking-tighter">{{ item.oee }}<span class="text-[10px] text-slate-400 ml-1">%</span></span>
                    </div>
                </div>

                <!-- Metrics Grid 2.0 -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/[0.02] p-3 rounded-xl border border-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,1)]"></span>
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">DISP.</span>
                        </div>
                        <p class="text-lg font-black text-white font-tech">{{ item.availability }}<span class="text-[10px] text-slate-400 ml-1">%</span></p>
                    </div>
                    <div class="bg-white/[0.02] p-3 rounded-xl border border-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,1)]"></span>
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">REND.</span>
                        </div>
                        <p class="text-lg font-black text-white font-tech">{{ item.performance }}<span class="text-[10px] text-slate-400 ml-1">%</span></p>
                    </div>
                </div>

                <!-- Life Meter (Predictive) -->
                {% if item.maint_progress > 0 %}
                <div class="bg-white/[0.02] rounded-xl px-4 py-3 border border-white/5">
                    <div class="flex justify-between items-center mb-1.5">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-tools text-[10px] text-amber-500"></i>
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Vida Útil (Service)</span>
                        </div>
                        <span class="text-[9px] font-tech font-bold {% if item.maint_progress > 80 %}text-rose-400{% else %}text-amber-400{% endif %}">
                            {{ item.maint_hours }} hs
                        </span>
                    </div>
                    <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden border border-white/5">
                        <div class="h-full bg-gradient-to-r {% if item.maint_progress > 80 %}from-rose-600 to-rose-400 shadow-[0_0_10px_rgba(244,63,94,0.3)]{% else %}from-amber-600 to-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.3)]{% endif %} transition-all duration-1000" 
                             style="width: {{ item.maint_progress }}%"></div>
                    </div>
                </div>
                {% endif %}

                <!-- Footer 2.0 -->
                <div class="pt-4 border-t border-white/5 flex justify-between items-center">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">PRODUCCION TOTAL</span>
                        <span class="text-sm font-black text-slate-200 font-tech uppercase">{{ item.actual_qty }} <span class="text-[10px] text-slate-500">PZ</span></span>
                    </div>
                    {% if item.oee >= 85 %}
                        <div class="bg-emerald-400/10 text-emerald-400 text-[10px] font-black px-3 py-1 rounded-lg border border-emerald-400/20">CLASE A</div>
                    {% elif item.oee >= 60 %}
                        <div class="bg-amber-400/10 text-amber-400 text-[10px] font-black px-3 py-1 rounded-lg border border-amber-400/20">ESTÁNDAR</div>
                    {% else %}
                        <div class="bg-red-400/10 text-red-400 text-[10px] font-black px-3 py-1 rounded-lg border border-red-400/20">CRÍTICO</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de Auditoría y Diagnóstico (Versión Final Saneada) -->
<div id="individual-audit-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-md" onclick="closeIndividualAudit()"></div>
    <div id="modal-box" class="w-full max-w-5xl h-[85vh] rounded-3xl border border-slate-700 shadow-2xl relative z-10 flex flex-col overflow-hidden bg-slate-900 transition-all duration-300">
        
        <!-- CABECERA PRINCIPAL -->
        <div id="audit-header" class="px-8 py-6 border-b border-white/5 flex justify-between items-center transition-colors">
            <div class="flex items-center gap-5">
                <div id="audit-icon-box" class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-500">
                    <i id="audit-main-icon" class="fas text-2xl"></i>
                </div>
                <div>
                    <h3 id="audit-modal-title" class="text-2xl font-black text-white leading-none mb-1 uppercase tracking-tighter">Cargando...</h3>
                    <div class="flex items-center gap-2">
                        <span id="audit-status-dot" class="w-2 h-2 rounded-full animate-pulse bg-emerald-500"></span>
                        <p id="audit-target-name" class="text-sm text-slate-400 font-black uppercase tracking-widest"></p>
                    </div>
                </div>
            </div>
            <button onclick="closeIndividualAudit()" class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center text-slate-400 hover:text-white hover:bg-red-500/40 transition-all border border-white/5">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- TABS DE NAVEGACIÓN (LOS 3 REPORTES) -->
        <div class="bg-slate-900/50 px-8 border-b border-white/5 flex gap-8">
            <button id="modal-tab-analysis" onclick="setModalTab('analysis')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-brain"></i> Análisis
            </button>
            <button id="modal-tab-metrics" onclick="setModalTab('metrics')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-chart-bar"></i> Métricas OEE
            </button>
            <button id="modal-tab-table" onclick="setModalTab('table')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-list-alt"></i> Log Técnico
            </button>
        </div>

        <!-- CONTENEDORES DE CONTENIDO -->
        <!-- VISTA 1: ANÁLISIS IA (CONVERSACIONAL) -->
        <div id="report-analysis-view" class="flex-grow overflow-y-auto p-10 hidden bg-indigo-950/5">
            <div id="analysis-content" class="text-slate-100 text-sm whitespace-pre-line leading-relaxed max-w-4xl mx-auto font-medium"></div>
        </div>

        <!-- VISTA 2: MÉTRICAS TÉCNICAS (NÚMEROS) -->
        <div id="report-metrics-view" class="flex-grow overflow-y-auto p-10 hidden bg-slate-900/50">
            <div id="metrics-content" class="text-slate-200 text-sm whitespace-pre-line leading-relaxed max-w-4xl mx-auto font-medium"></div>
        </div>

        <!-- VISTA 3: LOG TÉCNICO (TABLA ERP) -->
        <div id="report-table-view" class="flex-grow overflow-y-auto p-6 hidden">
            <table class="w-full text-left text-xs text-slate-300 border-separate border-spacing-y-2">
                <thead class="sticky top-0 bg-slate-800 text-slate-300 border-b border-white/5 z-10 shadow-sm">
                    <tr class="text-[10px] font-black uppercase tracking-widest">
                        <th class="p-4">Inicio</th><th class="p-4">Fin</th><th class="p-4">Orden</th><th class="p-4 text-center">Cant</th><th class="p-4">Artículo / Detalle</th><th class="p-4 text-center">Tiempo</th>
                    </tr>
                </thead>
                <tbody id="audit-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /**
     * Gestión de cambios de pestaña dentro del modal
     */
    function setModalTab(mode) {
        const header = document.getElementById('audit-header');
        const titleEl = document.getElementById('audit-modal-title');
        const iconEl = document.getElementById('audit-main-icon');
        const iconBox = document.getElementById('audit-icon-box');
        const statusDot = document.getElementById('audit-status-dot');
        
        // Ocultar todas las vistas y resetear pestañas
        const views = ['analysis', 'metrics', 'table'];
        views.forEach(m => {
            document.getElementById(`report-${m}-view`).classList.add('hidden');
            const tab = document.getElementById(`modal-tab-${m}`);
            tab.className = "py-4 text-[10px] font-bold uppercase tracking-widest border-b-2 border-transparent text-slate-500 hover:text-slate-300 transition-all flex items-center gap-2";
        });

        // Activar vista seleccionada
        document.getElementById(`report-${mode}-view`).classList.remove('hidden');
        const activeTab = document.getElementById(`modal-tab-${mode}`);

        // Actualizar colores y estilos según el modo
        if (mode === 'analysis') {
            titleEl.innerText = "Análisis de Desempeño";
            iconEl.className = "fas fa-brain";
            iconBox.className = "w-14 h-14 rounded-2xl bg-indigo-600/30 text-indigo-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-indigo-500/30 bg-indigo-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-500 text-indigo-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-indigo-500";
        } else if (mode === 'metrics') {
            titleEl.innerText = "Métricas Técnicas OEE";
            iconEl.className = "fas fa-chart-bar";
            iconBox.className = "w-14 h-14 rounded-2xl bg-sky-600/30 text-sky-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-sky-500/30 bg-sky-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-sky-500 text-sky-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-sky-500";
        } else {
            titleEl.innerText = "Auditoría Técnica Log";
            iconEl.className = "fas fa-stethoscope";
            iconBox.className = "w-14 h-14 rounded-2xl bg-teal-600/30 text-teal-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-teal-500/30 bg-teal-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-teal-500 text-teal-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-teal-500";
        }
    }

    /**
     * Carga de datos y apertura del modal
     */
    async function openIndividualAudit(targetId, targetName, mode = 'analysis') {
        const modal = document.getElementById('individual-audit-modal');
        document.getElementById('audit-target-name').innerText = targetName;
        modal.classList.remove('hidden');

        // Reset de contenidos con loading visual
        document.getElementById('analysis-content').innerHTML = '<div class="p-20 text-center text-slate-500 font-bold uppercase tracking-widest text-xs animate-pulse italic">Generando Diagnóstico IA Inteligente...</div>';
        document.getElementById('metrics-content').innerHTML = '<div class="p-20 text-center text-slate-500 font-bold uppercase tracking-widest text-xs animate-pulse italic">Calculando Métricas Técnicas OEE...</div>';
        document.getElementById('audit-table-body').innerHTML = '<tr><td colspan="6" class="p-16 text-center text-slate-500 font-black uppercase text-[10px] animate-pulse">Sincronizando con base de datos ERP...</td></tr>';

        setModalTab(mode);

        const url = `{% url 'obtener_auditoria' %}?id=${targetId}&view={{ view_type }}&start_date={{ fecha_target|date:'Y-m-d' }}{% if is_range %}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% endif %}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.status === 'success') {
                // 1. Inyectar Log Técnico (Tabla)
                let html = '';
                data.audit_log.forEach(log => {
                    html += `<tr class="bg-white/5 hover:bg-white/10 transition-all rounded-lg overflow-hidden group">
                        <td class="p-4 font-mono text-slate-100 text-[13px] font-bold border-l border-white/5">${log.inicio}</td>
                        <td class="p-4 font-mono text-indigo-300 text-[13px] font-bold">${log.fin}</td>
                        <td class="p-4 text-sky-400 font-mono font-black text-[13px]">${log.orden}</td>
                        <td class="p-4 text-center text-emerald-400 font-black text-lg">${log.cantidad}</td>
                        <td class="p-4">
                            <div class="font-black text-white text-xs uppercase">${log.articulo}</div>
                            <div class="text-[9px] text-slate-500 font-black uppercase tracking-widest mt-1">${log.maquina}</div>
                        </td>
                        <td class="p-4 text-center text-slate-300 font-bold border-r border-white/5 text-[13px]">${log.tiempo}</td>
                    </tr>`;
                });
                document.getElementById('audit-table-body').innerHTML = html || '<tr><td colspan="6" class="p-12 text-center text-slate-500 font-bold">SIN DATOS PARA EL PERIODO</td></tr>';
                
                // 2. Inyectar Reportes de Texto
                document.getElementById('analysis-content').innerHTML = data.analysis_conversational || "Análisis no disponible.";
                document.getElementById('metrics-content').innerHTML = data.analysis_detailed || "Métricas no disponibles.";
            }
        } catch (e) { 
            console.error('Error Crítico en Auditoría:', e);
            document.getElementById('audit-table-body').innerHTML = '<tr><td colspan="6" class="p-12 text-center text-red-500 font-black">ERROR DE CONEXIÓN CON EL SERVIDOR</td></tr>';
        }
    }

    function closeIndividualAudit() {
        document.getElementById('individual-audit-modal').classList.add('hidden');
    }

        function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        const btnGlobal = document.getElementById('btn-tab-global');
        const btnDetalle = document.getElementById('btn-tab-detalle');
        const active = "px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-blue-600 text-blue-600";
        const inactive = "px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-600";
        if (tabId === 'tab-global') {
            btnGlobal.className = active;
            btnDetalle.className = inactive;
        } else {
            btnGlobal.className = inactive;
            btnDetalle.className = active;
        }
    }

    // --- ESTILOS DINÁMICOS MODO TV ---
    {% if is_tv_mode %}
    (function() {
        const style = document.createElement('style');
        style.textContent = `
            body { background-color: #0f172a !important; overflow: hidden !important; }
            aside { display: none !important; }
            header { display: none !important; }
            main { padding: 0.5rem !important; height: 100vh !important; display: flex !important; flex-direction: column !important; }
            
            /* Contenedor Principal */
            .tab-content { flex: 1; overflow: hidden; padding-top: 0.25rem; }
            
            /* Compactar Header OEE */
            .bg-slate-900.rounded-xl.shadow-2xl.overflow-hidden.mb-6 { margin-bottom: 0.5rem !important; }
            .bg-blue-600.px-6.py-4 { padding: 0.5rem 1rem !important; } /* Barra Titulo azul */
            .px-10.py-5 { padding: 0.5rem !important; } /* Contenedor Gauges */
            
            /* Escalar Gauges */
            .w-40.h-20 { width: 8rem !important; height: 4rem !important; } /* 32/16 tailwind equiv aprox 128px */
            .w-40.h-40 { width: 8rem !important; height: 8rem !important; border-width: 8px !important; }
            .text-2xl { font-size: 1.25rem !important; } /* Texto % gauge */
            
            /* Gráficos más bajos */
            #chart-trend, #chart-pareto { height: 160px !important; min-height: 0 !important; }
            .h-56 { height: 10rem !important; } /* Contenedor grafico original */
            
            /* Grids más compactos */
            .gap-6 { gap: 0.75rem !important; }
            .p-5 { padding: 0.75rem !important; }
            .p-6 { padding: 1rem !important; }
            
            /* Ajuste Detalle Individual para Paginas de 8 */
            /* Ajuste Detalle Individual para Paginas de 8 */
            /* Ajuste Detalle Individual - CLASE FORZADA VIA JS */
            .tv-grid-override {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 1.5rem !important; /* Gap un poco mas grande para aire */
                justify-content: flex-start !important;
                align-content: flex-start !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0.5rem !important;
            }
            .tv-grid-override > div {
                flex: 0 0 23% !important; 
                max-width: 23% !important; 
                margin-bottom: 0 !important;
                display: none; /* Oculto por defecto, se activa con clase */
            }
            
            /* Clase para mostrar cards activas */
            .tv-page-active { display: flex !important; flex-direction: column !important; }
            
            /* Animaciones */
            #tab-global, #tab-detalle { animation: fadeIn 0.5s ease-in-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(style);

        // FORZAR REMOCION DE GRID TAILWIND
        const container = document.querySelector('#tab-detalle > div');
        if(container) {
            // Reemplazamos TODAS las clases por nuestra clase maestra
            container.className = 'tv-grid-override';
        }

        // LÓGICA DE ROTACIÓN Y PAGINACIÓN
        // Selector actualizado para usar la nueva clase o el hijo directo
        const cards = document.querySelectorAll('.tv-grid-override > div');
        const CARDS_PER_PAGE = 8;
        const totalPages = Math.ceil(cards.length / CARDS_PER_PAGE);
        let currentStep = -1; // -1 = Resumen Global, 0..N = Paginas de detalle

        function showPage(pageIndex) {
            cards.forEach((card, index) => {
                if (pageIndex === -1) {
                    card.classList.remove('tv-page-active'); // Ocultar todo si es resumen
                } else {
                    const start = pageIndex * CARDS_PER_PAGE;
                    const end = start + CARDS_PER_PAGE;
                    if (index >= start && index < end) {
                        card.classList.add('tv-page-active');
                    } else {
                        card.classList.remove('tv-page-active');
                    }
                }
            });
        }

        setInterval(() => {
            currentStep++;
            // Ciclo: Global -> Pag 0 -> Pag 1 -> ... -> Global
            if (currentStep >= totalPages) {
                currentStep = -1;
            }

            if (currentStep === -1) {
                switchTab('tab-global');
            } else {
                switchTab('tab-detalle');
                showPage(currentStep);
            }
        }, 20000);
        
        // Refresh total de datos cada 5 minutos
        setTimeout(() => { location.reload(); }, 300000);
    })();
    
    // FULLSCREEN TOGGLE LOGIC
    const fsToggle = document.getElementById('tv-fullscreen-toggle');
    if(fsToggle) {
        fsToggle.addEventListener('click', () => {
             if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.error(`Error attempting to enable fullscreen: ${e.message} (${e.name})`);
                });
                fsToggle.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fsToggle.innerHTML = '<i class="fas fa-expand"></i>';
                }
            }
        });
    }
    {% endif %}

    // --- ALERTAS DE VOZ INTELIGENTES (TTS) ---
    // Inicialización de síntesis de voz
    let audioEnabled = false;
    let speechSynth = window.speechSynthesis;
    let alertsAnnounced = new Set(); // Para no repetir la misma alerta constantemente

    function enableAudioContext() {
        audioEnabled = !audioEnabled;
        const btn = document.getElementById('btnAudio');
        
        if (audioEnabled) {
            btn.innerHTML = '<i class="fas fa-volume-up text-indigo-600"></i>';
            btn.classList.add('ring-2', 'ring-indigo-400', 'bg-indigo-50');
            // Test breve para "desbloquear" audio en móviles/browsers
            speak("Alertas de voz activadas.");
            checkCriticalAlerts(); // Chequear inmediatamente
        } else {
            btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            btn.classList.remove('ring-2', 'ring-indigo-400', 'bg-indigo-50');
            speechSynth.cancel();
        }
    }

    function speak(text) {
        if (!audioEnabled || !speechSynth) return;
        
        // Cancelar lo anterior para priorizar lo nuevo
        speechSynth.cancel(); 

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES'; // Español
        utterance.rate = 1.0; 
        utterance.pitch = 1.0;
        
        speechSynth.speak(utterance);
    }

    function checkCriticalAlerts() {
        if (!audioEnabled) return;

        // Buscar elementos con alerta visual de inactividad
        const alerts = document.querySelectorAll('.animate-bounce'); // Usamos la clase del badge rojo
        let message = "";
        let count = 0;

        alerts.forEach(alertEl => {
            const text = alertEl.innerText;
            // Extraer info: "35 MIN. INACTIVO" -> 35
            // Buscar el nombre de la máquina asociado (está en el padre)
            const card = alertEl.closest('.group');
            const machineName = card.querySelector('h3').innerText;

            const alertId = machineName + text; 
            
            // Si no se anunció recientemente
            if (!alertsAnnounced.has(alertId)) {
                message += `Atención. ${machineName} detenida por más de 30 minutos. `;
                alertsAnnounced.add(alertId);
                count++;
                
                // Limpiar del set después de 10 min para volver a avisar si sigue igual
                setTimeout(() => alertsAnnounced.delete(alertId), 600000); 
            }
        });

        if (count > 0) {
            speak(message + " Por favor verificar.");
        }
    }

    // --- GRÁFICOS APEX ---
    document.addEventListener('DOMContentLoaded', function() {
        // Full Screen Toggle Logic (Top Bar)
        const btnFs = document.getElementById('btnFullScreen');
        if (btnFs) {
            btnFs.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    btnFs.innerHTML = '<i class="fas fa-compress"></i><span class="hidden sm:inline">SALIR</span>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        btnFs.innerHTML = '<i class="fas fa-expand"></i><span class="hidden sm:inline">PANTALLA</span>';
                    }
                }
            });
        }
        
        // Chequear alertas periodicamente si está activado
        setInterval(checkCriticalAlerts, 60000); // Cada 1 min

        const trendData = JSON.parse('{{ history_trend|safe }}');
        const paretoData = JSON.parse('{{ pareto_data|safe }}');

        if(document.getElementById('chart-trend')) {
            new ApexCharts(document.getElementById('chart-trend'), {
                series: [{ name: 'OEE Global', data: trendData.map(i => i.oee) }],
                chart: { height: '100%', type: 'line', toolbar: { show: false }, foreColor: '#94a3b8' },
                stroke: { curve: 'smooth', width: 4 },
                xaxis: { categories: trendData.map(i => i.day) },
                yaxis: { max: 100 },
                grid: { borderColor: '#334155' }
            }).render();
        }

        if(document.getElementById('chart-pareto')) {
            if (paretoData && paretoData.labels && paretoData.labels.length > 0) {
                new ApexCharts(document.getElementById('chart-pareto'), {
                    series: [
                        {
                            name: 'Tiempo (Min)',
                            type: 'column',
                            data: paretoData.values
                        },
                        {
                            name: 'Acumulado %',
                            type: 'line',
                            data: paretoData.cumulative
                        }
                    ],
                    chart: { 
                        height: '100%', 
                        type: 'line', 
                        toolbar: { show: false }, 
                        foreColor: '#94a3b8',
                        animations: { enabled: true, easing: 'easeinout', speed: 800 }
                    },
                    stroke: { width: [0, 3], curve: 'smooth' },
                    plotOptions: {
                        bar: { borderRadius: 2, distributed: true, columnWidth: '60%' }
                    },
                    colors: ['#3b82f6', '#f59e0b', '#10b981', '#f43f5e', '#8b5cf6'],
                    dataLabels: {
                        enabled: true,
                        enabledOnSeries: [0, 1],
                        formatter: function (val, opts) {
                            if (opts.seriesIndex === 1) return val + "%";
                            const h = Math.floor(val / 60);
                            return h > 0 ? h + "h" : val + "m";
                        },
                        style: { fontSize: '10px', fontWeight: 'bold' },
                        background: { enabled: true, foreColor: '#fff', borderRadius: 2, opacity: 0.9, borderWidth: 0 }
                    },
                    legend: { show: false },
                    xaxis: { 
                        categories: paretoData.labels,
                        labels: { style: { fontSize: '10px' }, rotate: -45, trim: true }
                    },
                    yaxis: [
                        {
                            title: { text: 'Minutos', style: { color: '#3b82f6', fontSize: '10px' } },
                            labels: { style: { colors: '#94a3b8' } }
                        },
                        {
                            opposite: true,
                            title: { text: '% Acumulado', style: { color: '#f59e0b', fontSize: '10px' } },
                            max: 105,
                            labels: { style: { colors: '#94a3b8' } }
                        }
                    ],
                    grid: { borderColor: '#334155', strokeDashArray: 4 },
                    tooltip: { theme: 'dark', shared: true, intersect: false }
                }).render();
            } else {
                 document.getElementById('chart-pareto').innerHTML = "<div class='h-full flex items-center justify-center text-slate-600 text-xs font-bold uppercase tracking-widest'>Sin datos de paradas</div>";
            }
        }
    });
</script>
{% endblock %}
