{% extends 'base.html' %}
{% load l10n %}

{% block title %}Tablero de Producción - OEE{% endblock %}

{% block content %}
<!-- Premium Tooltip CSS -->
<style>
    .smart-popover {
        position: fixed;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 320px;
    }
    .smart-popover.active {
        opacity: 1;
        transform: translateY(0);
    }
    .report-main-title {
        display: block;
        font-size: 1.25rem;
        font-weight: 900;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: -0.025em;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 0.5rem;
    }
    .glass-card {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5), 0 8px 10px -6px rgb(0 0 0 / 0.5);
    }
    .explain-trigger {
        cursor: help;
        border-bottom: 1px dotted rgba(255,255,255,0.2);
    }
    .explain-trigger:hover {
        border-bottom-color: #3b82f6;
        color: #fff;
    }

    /* Fixed Header Positioning - Compensate for base layout padding */
    .sticky-header-container {
        position: sticky;
        top: -16px; /* p-4 in base.html */
        z-index: 50;
        background-color: #f8fafc; /* bg-slate-50 */
        margin: -16px -16px 24px -16px;
        padding: 16px 16px 0 16px;
        border-bottom-width: 1px;
        border-color: #e2e8f0; /* border-slate-200 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    @media (min-width: 768px) {
        .sticky-header-container {
            top: -32px; /* md:p-8 in base.html */
            margin: -32px -32px 24px -32px;
            padding: 32px 32px 0 32px;
        }
    }
    /* Icon Pulse Animation */
    @keyframes icon-pulse {
        0% { transform: scale(1); filter: brightness(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        50% { transform: scale(1.08); filter: brightness(1.4); }
        100% { transform: scale(1); filter: brightness(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }
    .animate-icon-pulse {
        animation: icon-pulse 2s infinite ease-in-out;
    }
</style>

<div id="global-popover" class="smart-popover glass-card rounded-xl p-4 hidden">
    <div class="flex items-center gap-3 mb-2 border-b border-slate-700/50 pb-2">
        <div id="popover-icon" class="w-8 h-8 rounded-lg flex items-center justify-center text-white bg-blue-600">
            <i class="fas fa-info-circle"></i>
        </div>
        <h4 id="popover-title" class="font-bold text-white text-sm uppercase tracking-wider">Detalle del Valor</h4>
    </div>
    <p id="popover-text" class="text-slate-300 text-[13px] leading-relaxed"></p>
    <div class="mt-3 pt-2 border-t border-slate-700/50 text-[10px] text-slate-500 font-bold uppercase flex justify-between">
        <span>DATOS DEL SISTEMA</span>
        <span id="popover-calc-type">Cálculo Automático</span>
    </div>
</div>

<!-- 1. UNIFIED STICKY HEADER (OEE + FILTERS + TABS) -->
<div class="sticky-header-container">
    
    <!-- A. OVERALL OEE PANEL -->
    {% localize off %}
    <div class="bg-slate-800 rounded-lg shadow-2xl overflow-hidden border border-slate-700 mb-5">
        <!-- Header Azul/Indigo -->
        <div class="bg-gradient-to-r {% if view_type == 'personnel' %}from-indigo-600 to-blue-700{% else %}from-blue-600 to-indigo-700{% endif %} px-8 py-4 flex justify-between items-center group">
            <h2 class="text-white font-bold text-lg tracking-wide explain-trigger"
                data-title="OEE Global {% if view_type == 'personnel' %}(Personal){% else %}(Máquinas){% endif %}"
                data-icon="fa-chart-pie"
                data-color="bg-blue-800"
                data-desc="OEE Global consolidado del periodo seleccionado.">
                OEE Global ({{ resumen_activo.promedio_oee }}%)
            </h2>
            <div class="flex gap-4 items-center">
                {% if view_type == 'machines' and not is_tv_mode %}
                <a href="{% url 'gestion_maquinas' %}" class="flex gap-2 text-white bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-[10px] font-semibold uppercase tracking-wider transition-colors items-center">
                    <i class="fas fa-cogs"></i> <span>Configurar</span>
                </a>
                {% endif %}
                <div class="flex gap-2 text-blue-100 text-sm border-l border-white/20 pl-4 items-center">
                    <i class="fas fa-calendar-day"></i> 
                    <span class="font-mono font-bold tracking-tight">
                        {% if is_range %}{{ fecha_target|date:"d M" }} - {{ fecha_fin_target|date:"d M Y" }}{% else %}{{ fecha_target|date:"d M Y" }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Gauges Row -->
        <div class="px-10 py-5 grid grid-cols-1 md:grid-cols-3 gap-6 text-center text-white">
            <!-- Availability Gauge -->
            <div class="flex flex-col items-center">
                <div class="relative w-40 h-20 overflow-hidden mb-1">
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-slate-700 box-border"></div>
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-teal-400 box-border origin-center" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_availability > 100 %}100{% else %}{{ resumen_activo.avg_availability }}{% endif %} - 180deg));"></div> 
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-2xl font-bold text-white">{{ resumen_activo.avg_availability }}%</span>
                    </div>
                </div>
                <span class="text-teal-400 font-bold uppercase tracking-wider text-[10px]">Disponibilidad</span>
            </div>

            <!-- Performance Gauge -->
            <div class="flex flex-col items-center">
                <div class="relative w-40 h-20 overflow-hidden mb-1">
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-slate-700 box-border"></div>
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-lime-400 box-border" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_performance > 100 %}100{% else %}{{ resumen_activo.avg_performance }}{% endif %} - 180deg));"></div>
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-2xl font-bold text-white">{{ resumen_activo.avg_performance }}%</span>
                    </div>
                </div>
                <span class="text-lime-400 font-bold uppercase tracking-wider text-[10px]">Rendimiento</span>
            </div>

            <!-- Quality Gauge -->
            <div class="flex flex-col items-center">
                <div class="relative w-40 h-20 overflow-hidden mb-1">
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-slate-700 box-border"></div>
                    <div class="absolute w-40 h-40 rounded-full border-[12px] border-amber-500 box-border" 
                            style="clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); transform: rotate(calc(1.8deg * {% if resumen_activo.avg_quality > 100 %}100{% else %}{{ resumen_activo.avg_quality }}{% endif %} - 180deg));"></div>
                    <div class="absolute bottom-0 w-full text-center">
                        <span class="text-2xl font-bold text-white">{{ resumen_activo.avg_quality }}%</span>
                    </div>
                </div>
                <span class="text-amber-500 font-bold uppercase tracking-wider text-[10px]">Calidad</span>
            </div>
        </div>
    </div>
    {% endlocalize %}

    <!-- B. DATE NAVIGATION & PERSPECTIVE (Oculto en TV) -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4 {% if is_tv_mode %}hidden{% endif %}">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-slate-800">Tablero de Control</h1>
            <div class="flex bg-slate-200 p-1 rounded-lg border border-slate-300 shadow-inner overflow-hidden">
                <a href="?view=machines&{% if is_range %}start_date={{ fecha_target|date:'Y-m-d' }}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% else %}date={{ fecha_target|date:'Y-m-d' }}{% endif %}" 
                    class="px-4 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-2 {% if view_type == 'machines' %}bg-white text-blue-600 shadow-sm{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                    <i class="fas fa-microchip"></i> Máquinas
                </a>
                <a href="?view=personnel&{% if is_range %}start_date={{ fecha_target|date:'Y-m-d' }}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% else %}date={{ fecha_target|date:'Y-m-d' }}{% endif %}" 
                    class="px-4 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-2 {% if view_type == 'personnel' %}bg-white text-indigo-600 shadow-sm{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                    <i class="fas fa-users"></i> Personal
                </a>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
            <a href="?date=today" class="{% if is_today and not is_range %}bg-blue-600 ring-2 ring-blue-400 text-white{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %} px-3 py-1.5 rounded shadow transition-all font-medium text-xs flex items-center gap-2">
                <i class="fas fa-calendar-day"></i> Hoy
            </a>
            <a href="?date=yesterday" class="{% if not is_today and not is_range %}bg-blue-600 ring-2 ring-blue-400 text-white{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %} px-3 py-1.5 rounded shadow transition-all font-medium text-xs flex items-center gap-2">
                <i class="fas fa-history"></i> Ayer
            </a>
            <div class="relative">
                <button onclick="document.getElementById('range-form').classList.toggle('hidden')" class="{% if is_range %}bg-blue-600 ring-2 ring-blue-400 text-white{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %} px-3 py-1.5 rounded shadow transition-all font-medium text-xs flex items-center gap-2">
                    <i class="fas fa-calendar-alt"></i> Intervalo
                </button>
                <div id="range-form" class="hidden absolute right-0 mt-2 bg-white p-4 rounded-lg shadow-xl border border-slate-200 z-[100] w-64">
                    <form method="GET" class="space-y-3">
                        <input type="hidden" name="view" value="{{ view_type }}">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Desde</label>
                            <input type="date" name="start_date" value="{{ fecha_target|date:'Y-m-d' }}" class="w-full text-xs border-slate-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Hasta</label>
                            <input type="date" name="end_date" value="{{ fecha_fin_target|date:'Y-m-d' }}" class="w-full text-xs border-slate-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded text-[10px] font-bold uppercase hover:bg-blue-700 transition-colors">
                            Aplicar Filtro
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex items-center bg-slate-200/50 rounded p-1 border border-slate-200 shadow-inner">
                <a href="?format=clock" class="px-3 py-1 flex items-center gap-2 rounded text-[10px] font-bold transition-all {% if time_format == 'clock' %}bg-white text-blue-600 shadow-sm{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                    <i class="fas fa-clock"></i> Reloj
                </a>
                <a href="?format=decimal" class="px-3 py-1 flex items-center gap-2 rounded text-[10px] font-bold transition-all {% if time_format == 'decimal' %}bg-white text-blue-600 shadow-sm{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                    <i class="fas fa-calculator"></i> Decimal
                </a>
            </div>
            <!-- TV Mode Toggle -->
            <a href="?mode={% if is_tv_mode %}normal{% else %}tv{% endif %}" class="{% if is_tv_mode %}bg-emerald-600 ring-2 ring-emerald-400 text-white animate-pulse{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %} px-3 py-1.5 rounded shadow transition-all font-medium text-xs flex items-center gap-2">
                <i class="fas fa-desktop"></i> MODO TV
            </a>
        </div>
    </div>

    <!-- C. TABS Selector (Oculto en TV porque rotan solas) -->
    <div class="flex border-b border-slate-200 gap-2 {% if is_tv_mode %}hidden{% endif %}">
        <button onclick="switchTab('tab-global')" id="btn-tab-global" 
            class="px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-blue-600 text-blue-600">
            Resumen General
        </button>
        <button onclick="switchTab('tab-detalle')" id="btn-tab-detalle" 
            class="px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-600">
            Detalle Individual
        </button>
    </div>
</div>

{% if is_tv_mode %}
<!-- Exit TV Mode Button -->
<a href="?mode=normal" 
   class="fixed bottom-6 right-24 z-[9999] w-14 h-14 bg-red-600/80 hover:bg-red-500 text-white rounded-full shadow-[0_0_20px_rgba(220,38,38,0.5)] flex items-center justify-center transition-all backdrop-blur-md border border-white/20 hover:scale-110 active:scale-95 group"
   title="Salir de Modo TV">
    <i class="fas fa-door-open text-xl drop-shadow-md"></i>
</a>

<!-- Floating Fullscreen Toggle Button for TV Mode -->
<button id="tv-fullscreen-toggle" 
        class="fixed bottom-6 right-6 z-[9999] w-14 h-14 bg-blue-600/80 hover:bg-blue-500 text-white rounded-full shadow-[0_0_20px_rgba(37,99,235,0.5)] flex items-center justify-center transition-all backdrop-blur-md border border-white/20 hover:scale-110 active:scale-95 group"
        title="Pantalla Completa / Ventana">
    <i class="fas fa-expand text-xl drop-shadow-md"></i>
</button>
{% endif %}

<div id="tab-global" class="tab-content space-y-6">
    <!-- C. GRÁFICOS AVANZADOS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gráfico de Tendencia -->
        <div class="bg-slate-800 rounded-lg p-5 border border-slate-700 shadow-xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-chart-line text-6xl text-blue-500"></i>
            </div>
            <h3 class="text-white font-bold text-sm mb-4 flex items-center gap-2 relative z-10 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                Evolución OEE (7 Días)
            </h3>
            <div id="chart-trend" class="h-56 relative z-10 w-full"></div>
        </div>
        <!-- Pareto de Paradas -->
        <div class="bg-slate-800 rounded-lg p-5 border border-slate-700 shadow-xl relative overflow-hidden group">
             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-clock text-6xl text-amber-500"></i>
            </div>
            <h3 class="text-white font-bold text-sm mb-4 flex items-center gap-2 relative z-10 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                Pareto de Paradas (Hs / Motivo)
            </h3>
            <div id="chart-pareto" class="h-56 relative z-10 w-full"></div>
        </div>
    </div>

    <!-- Detailed Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Availability Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-teal-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Disponibilidad</span>
                <span class="text-white/90">{{ resumen_activo.avg_availability }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Esperado</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_planned_formatted }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_formatted }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-teal-400 shadow-[0_0_10px_rgba(45,212,191,0.5)] transition-all duration-1000" style="width: {{ resumen_activo.avg_availability }}%"></div>
                </div>
            </div>
        </div>

        <!-- Performance Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-lime-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Rendimiento</span>
                <span class="text-white/90">{{ resumen_activo.avg_performance }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">T. Estándar</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_standard_formatted }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-lime-400 shadow-[0_0_10px_rgba(163,230,53,0.5)] transition-all duration-1000" style="width: {% if resumen_activo.avg_performance > 100 %}100{% else %}{{ resumen_activo.avg_performance }}{% endif %}%"></div>
                </div>
            </div>
        </div>

        <!-- Quality Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-amber-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Calidad</span>
                <span class="text-white/90">{{ resumen_activo.avg_quality }}%</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_actual_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Reproceso</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_rejected_qty }}</span>
                </div>
                <div class="relative h-2 rounded-full bg-slate-900 border border-slate-700 overflow-hidden mt-4">
                    <div class="absolute top-0 left-0 h-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)] transition-all duration-1000" style="width: {{ resumen_activo.avg_quality }}%"></div>
                </div>
            </div>
        </div>

        <!-- Active Count Card -->
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl">
            <div class="bg-indigo-600 px-4 py-2 font-bold text-white tracking-wide flex justify-between items-center text-sm">
                <span>Estado Operativo</span>
                <span class="text-white/90">{{ resumen_activo.promedio_oee }}% OEE</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Activos</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.active_count }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-slate-400 text-sm font-medium">Piezas Totales</span>
                    <span class="text-white font-bold text-lg">{{ resumen_activo.global_total_qty }}</span>
                </div>
                <div class="pt-4 border-t border-slate-700/30">
                    <span class="flex items-center gap-1.5 text-emerald-400 text-[10px] font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        DATOS EN VIVO
                    </span>
                </div>
            </div>
        </div>

        <!-- Unassigned Card (Solo en vista máquinas para ver qué falta configurar) -->
        {% if view_type == 'machines' %}
        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-xl border-t-amber-500/50 border-t-2">
            <div class="bg-amber-600/20 px-4 py-2 font-bold text-amber-500 tracking-wide flex justify-between items-center text-sm">
                <span>Sin Asignar</span>
                <span class="text-amber-500/90 italic text-[10px]">Fuera de Dashboard</span>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-sm font-medium">Cant. Real</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase">Piezas sin máquina</span>
                    </div>
                    <span class="text-white font-bold text-lg">{{ resumen.unassigned_qty }}</span>
                </div>
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-sm font-medium">Tiempo Total</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase">Maquinas inactivas</span>
                    </div>
                    <span class="text-white font-bold text-lg">{{ resumen.unassigned_time_formatted }}</span>
                </div>
                <div class="pt-4 border-t border-slate-700/30 flex justify-between items-center">
                    <span class="text-amber-500/80 text-[10px] font-bold uppercase tracking-tighter">
                        <i class="fas fa-exclamation-circle mr-1"></i> Requiere Config.
                    </span>
                    <a href="{% url 'gestion_maquinas' %}" class="text-[9px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 px-2 py-1 rounded border border-amber-500/20 transition-all font-black">EDITAR</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div id="tab-detalle" class="tab-content hidden space-y-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for item in cards_data %}
        <div class="bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 hover:border-slate-500 transition-all shadow-xl group relative">
            <!-- ALERTA INACTIVIDAD MODO TV -->
            {% if is_tv_mode and item.idle_mins > 30 and is_today %}
                <div class="absolute inset-0 bg-red-600/10 animate-pulse pointer-events-none z-[5]"></div>
                <div class="absolute top-0 right-0 p-2 z-[20]">
                     <span class="flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 shadow-[0_0_10px_rgba(239,68,68,1)]"></span>
                    </span>
                </div>
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[20] bg-red-600 text-white text-[9px] px-3 py-1 rounded-full font-black shadow-2xl animate-bounce flex items-center gap-1.5 whitespace-nowrap">
                    <i class="fas fa-exclamation-triangle"></i> {{ item.idle_mins|floatformat:0 }} MIN. INACTIVO
                </div>
            {% endif %}
             <div class="bg-slate-900/50 px-5 py-4 border-b border-slate-700/50 flex justify-between items-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-600/20 flex items-center justify-center text-indigo-400 group-hover:bg-indigo-600 group-hover:text-white transition-all">
                        <i class="fas {% if view_type == 'personnel' %}fa-user{% else %}fa-microchip{% endif %}"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold leading-none mb-1 group-hover:text-blue-400 transition-colors">{{ item.name }}</h3>
                        <p class="text-xs text-slate-300 font-mono uppercase">
                            {% if view_type == 'personnel' %}{{ item.last_machine|default:item.id }}{% else %}{{ item.operator_name|default:item.id }}{% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex gap-2">
                     <!-- Botón Auditoría (Abre el diagnóstico y log técnico) -->
                    <button onclick="openIndividualAudit('{{ item.id }}', '{{ item.name|escapejs }}', 'analysis')" 
                            title="Ver Auditoría y Diagnóstico"
                            class="w-8 h-8 rounded-lg bg-slate-800 border border-slate-700 text-indigo-400 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-lg">
                        <i class="fas fa-stethoscope text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="p-5 space-y-5">
                {% if view_type != 'personnel' and item.mantenimiento %}
                <div class="animate-pulse bg-red-500/10 border border-red-500/50 rounded-xl p-3 flex items-center justify-between shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <span class="text-red-500 text-[10px] font-black uppercase tracking-wider">
                            {{ item.mantenimiento.estado_display }}
                        </span>
                    </div>
                    <span class="text-slate-300 text-[9px] font-bold">Técnico: {{ item.mantenimiento.tecnico|default:"S/N" }}</span>
                </div>
                {% endif %}

                <div class="bg-slate-900/40 rounded-xl p-3 border border-slate-700/50">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Motivo / Estado</p>
                        <p class="text-[9px] font-bold text-indigo-400 uppercase truncate max-w-[150px]" title="{{ item.article_desc }}">
                            {{ item.article_desc|default:"---" }}
                        </p>
                    </div>
                    <p class="text-blue-300 text-xs font-bold italic truncate">{{ item.last_reason|default:"Sin actividad" }}</p>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-slate-900/20 p-2 rounded border border-slate-700/30">
                        <p class="text-[10px] text-slate-300 font-bold uppercase mb-1">Disp.</p>
                        <p class="text-xs text-teal-400 font-black">{{ item.availability }}%</p>
                    </div>
                    <div class="bg-slate-900/20 p-2 rounded border border-slate-700/30">
                        <p class="text-[10px] text-slate-300 font-bold uppercase mb-1">Rend.</p>
                        <p class="text-xs text-lime-400 font-black">{{ item.performance }}%</p>
                    </div>
                    <div class="bg-slate-900/20 p-2 rounded border border-slate-700/30">
                        <p class="text-[10px] text-slate-300 font-bold uppercase mb-1">Cal.</p>
                        <p class="text-xs text-amber-400 font-black">{{ item.quality }}%</p>
                    </div>
                </div>

                <div class="flex justify-between items-end pt-2">
                    <div>
                        <p class="text-[10px] font-bold text-slate-300 uppercase">OEE Final</p>
                        <p class="text-2xl font-black text-white group-hover:text-blue-400 transition-all">{{ item.oee }}%</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-300 uppercase">Total Producido</p>
                        <p class="text-lg font-bold text-emerald-400">{{ item.actual_qty }} <span class="text-[10px] text-slate-500">pz</span></p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de Auditoría y Diagnóstico (Versión Final Saneada) -->
<div id="individual-audit-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-md" onclick="closeIndividualAudit()"></div>
    <div id="modal-box" class="w-full max-w-5xl h-[85vh] rounded-3xl border border-slate-700 shadow-2xl relative z-10 flex flex-col overflow-hidden bg-slate-900 transition-all duration-300">
        
        <!-- CABECERA PRINCIPAL -->
        <div id="audit-header" class="px-8 py-6 border-b border-white/5 flex justify-between items-center transition-colors">
            <div class="flex items-center gap-5">
                <div id="audit-icon-box" class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-500">
                    <i id="audit-main-icon" class="fas text-2xl"></i>
                </div>
                <div>
                    <h3 id="audit-modal-title" class="text-2xl font-black text-white leading-none mb-1 uppercase tracking-tighter">Cargando...</h3>
                    <div class="flex items-center gap-2">
                        <span id="audit-status-dot" class="w-2 h-2 rounded-full animate-pulse bg-emerald-500"></span>
                        <p id="audit-target-name" class="text-sm text-slate-400 font-black uppercase tracking-widest"></p>
                    </div>
                </div>
            </div>
            <button onclick="closeIndividualAudit()" class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center text-slate-400 hover:text-white hover:bg-red-500/40 transition-all border border-white/5">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- TABS DE NAVEGACIÓN (LOS 3 REPORTES) -->
        <div class="bg-slate-900/50 px-8 border-b border-white/5 flex gap-8">
            <button id="modal-tab-analysis" onclick="setModalTab('analysis')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-brain"></i> Análisis
            </button>
            <button id="modal-tab-metrics" onclick="setModalTab('metrics')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-chart-bar"></i> Métricas OEE
            </button>
            <button id="modal-tab-table" onclick="setModalTab('table')" class="py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all flex items-center gap-2">
                <i class="fas fa-list-alt"></i> Log Técnico
            </button>
        </div>

        <!-- CONTENEDORES DE CONTENIDO -->
        <!-- VISTA 1: ANÁLISIS IA (CONVERSACIONAL) -->
        <div id="report-analysis-view" class="flex-grow overflow-y-auto p-10 hidden bg-indigo-950/5">
            <div id="analysis-content" class="text-slate-100 text-sm whitespace-pre-line leading-relaxed max-w-4xl mx-auto font-medium"></div>
        </div>

        <!-- VISTA 2: MÉTRICAS TÉCNICAS (NÚMEROS) -->
        <div id="report-metrics-view" class="flex-grow overflow-y-auto p-10 hidden bg-slate-900/50">
            <div id="metrics-content" class="text-slate-200 text-sm whitespace-pre-line leading-relaxed max-w-4xl mx-auto font-medium"></div>
        </div>

        <!-- VISTA 3: LOG TÉCNICO (TABLA ERP) -->
        <div id="report-table-view" class="flex-grow overflow-y-auto p-6 hidden">
            <table class="w-full text-left text-xs text-slate-300 border-separate border-spacing-y-2">
                <thead class="sticky top-0 bg-slate-800 text-slate-300 border-b border-white/5 z-10 shadow-sm">
                    <tr class="text-[10px] font-black uppercase tracking-widest">
                        <th class="p-4">Inicio</th><th class="p-4">Fin</th><th class="p-4">Orden</th><th class="p-4 text-center">Cant</th><th class="p-4">Artículo / Detalle</th><th class="p-4 text-center">Tiempo</th>
                    </tr>
                </thead>
                <tbody id="audit-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /**
     * Gestión de cambios de pestaña dentro del modal
     */
    function setModalTab(mode) {
        const header = document.getElementById('audit-header');
        const titleEl = document.getElementById('audit-modal-title');
        const iconEl = document.getElementById('audit-main-icon');
        const iconBox = document.getElementById('audit-icon-box');
        const statusDot = document.getElementById('audit-status-dot');
        
        // Ocultar todas las vistas y resetear pestañas
        const views = ['analysis', 'metrics', 'table'];
        views.forEach(m => {
            document.getElementById(`report-${m}-view`).classList.add('hidden');
            const tab = document.getElementById(`modal-tab-${m}`);
            tab.className = "py-4 text-[10px] font-bold uppercase tracking-widest border-b-2 border-transparent text-slate-500 hover:text-slate-300 transition-all flex items-center gap-2";
        });

        // Activar vista seleccionada
        document.getElementById(`report-${mode}-view`).classList.remove('hidden');
        const activeTab = document.getElementById(`modal-tab-${mode}`);

        // Actualizar colores y estilos según el modo
        if (mode === 'analysis') {
            titleEl.innerText = "Análisis de Desempeño";
            iconEl.className = "fas fa-brain";
            iconBox.className = "w-14 h-14 rounded-2xl bg-indigo-600/30 text-indigo-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-indigo-500/30 bg-indigo-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-500 text-indigo-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-indigo-500";
        } else if (mode === 'metrics') {
            titleEl.innerText = "Métricas Técnicas OEE";
            iconEl.className = "fas fa-chart-bar";
            iconBox.className = "w-14 h-14 rounded-2xl bg-sky-600/30 text-sky-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-sky-500/30 bg-sky-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-sky-500 text-sky-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-sky-500";
        } else {
            titleEl.innerText = "Auditoría Técnica Log";
            iconEl.className = "fas fa-stethoscope";
            iconBox.className = "w-14 h-14 rounded-2xl bg-teal-600/30 text-teal-400 shadow-lg flex items-center justify-center animate-icon-pulse";
            header.className = "px-8 py-6 border-b border-teal-500/30 bg-teal-950/40 flex justify-between items-center transition-all duration-300";
            activeTab.className = "py-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-teal-500 text-teal-400 flex items-center gap-2";
            statusDot.className = "w-2 h-2 rounded-full animate-pulse bg-teal-500";
        }
    }

    /**
     * Carga de datos y apertura del modal
     */
    async function openIndividualAudit(targetId, targetName, mode = 'analysis') {
        const modal = document.getElementById('individual-audit-modal');
        document.getElementById('audit-target-name').innerText = targetName;
        modal.classList.remove('hidden');

        // Reset de contenidos con loading visual
        document.getElementById('analysis-content').innerHTML = '<div class="p-20 text-center text-slate-500 font-bold uppercase tracking-widest text-xs animate-pulse italic">Generando Diagnóstico IA Inteligente...</div>';
        document.getElementById('metrics-content').innerHTML = '<div class="p-20 text-center text-slate-500 font-bold uppercase tracking-widest text-xs animate-pulse italic">Calculando Métricas Técnicas OEE...</div>';
        document.getElementById('audit-table-body').innerHTML = '<tr><td colspan="6" class="p-16 text-center text-slate-500 font-black uppercase text-[10px] animate-pulse">Sincronizando con base de datos ERP...</td></tr>';

        setModalTab(mode);

        const url = `{% url 'obtener_auditoria' %}?id=${targetId}&view={{ view_type }}&start_date={{ fecha_target|date:'Y-m-d' }}{% if is_range %}&end_date={{ fecha_fin_target|date:'Y-m-d' }}{% endif %}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.status === 'success') {
                // 1. Inyectar Log Técnico (Tabla)
                let html = '';
                data.audit_log.forEach(log => {
                    html += `<tr class="bg-white/5 hover:bg-white/10 transition-all rounded-lg overflow-hidden group">
                        <td class="p-4 font-mono text-slate-100 text-[13px] font-bold border-l border-white/5">${log.inicio}</td>
                        <td class="p-4 font-mono text-indigo-300 text-[13px] font-bold">${log.fin}</td>
                        <td class="p-4 text-sky-400 font-mono font-black text-[13px]">${log.orden}</td>
                        <td class="p-4 text-center text-emerald-400 font-black text-lg">${log.cantidad}</td>
                        <td class="p-4">
                            <div class="font-black text-white text-xs uppercase">${log.articulo}</div>
                            <div class="text-[9px] text-slate-500 font-black uppercase tracking-widest mt-1">${log.maquina}</div>
                        </td>
                        <td class="p-4 text-center text-slate-300 font-bold border-r border-white/5 text-[13px]">${log.tiempo}</td>
                    </tr>`;
                });
                document.getElementById('audit-table-body').innerHTML = html || '<tr><td colspan="6" class="p-12 text-center text-slate-500 font-bold">SIN DATOS PARA EL PERIODO</td></tr>';
                
                // 2. Inyectar Reportes de Texto
                document.getElementById('analysis-content').innerHTML = data.analysis_conversational || "Análisis no disponible.";
                document.getElementById('metrics-content').innerHTML = data.analysis_detailed || "Métricas no disponibles.";
            }
        } catch (e) { 
            console.error('Error Crítico en Auditoría:', e);
            document.getElementById('audit-table-body').innerHTML = '<tr><td colspan="6" class="p-12 text-center text-red-500 font-black">ERROR DE CONEXIÓN CON EL SERVIDOR</td></tr>';
        }
    }

    function closeIndividualAudit() {
        document.getElementById('individual-audit-modal').classList.add('hidden');
    }

        function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        const btnGlobal = document.getElementById('btn-tab-global');
        const btnDetalle = document.getElementById('btn-tab-detalle');
        const active = "px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-blue-600 text-blue-600";
        const inactive = "px-6 py-3 font-bold text-xs uppercase tracking-wider transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-600";
        if (tabId === 'tab-global') {
            btnGlobal.className = active;
            btnDetalle.className = inactive;
        } else {
            btnGlobal.className = inactive;
            btnDetalle.className = active;
        }
    }

    // --- ESTILOS DINÁMICOS MODO TV ---
    {% if is_tv_mode %}
    (function() {
        const style = document.createElement('style');
        style.textContent = `
            body { background-color: #0f172a !important; overflow: hidden !important; }
            aside { display: none !important; }
            header { display: none !important; }
            main { padding: 0.5rem !important; height: 100vh !important; display: flex !important; flex-direction: column !important; }
            
            /* Contenedor Principal */
            .tab-content { flex: 1; overflow: hidden; padding-top: 0.25rem; }
            
            /* Compactar Header OEE */
            .bg-slate-900.rounded-xl.shadow-2xl.overflow-hidden.mb-6 { margin-bottom: 0.5rem !important; }
            .bg-blue-600.px-6.py-4 { padding: 0.5rem 1rem !important; } /* Barra Titulo azul */
            .px-10.py-5 { padding: 0.5rem !important; } /* Contenedor Gauges */
            
            /* Escalar Gauges */
            .w-40.h-20 { width: 8rem !important; height: 4rem !important; } /* 32/16 tailwind equiv aprox 128px */
            .w-40.h-40 { width: 8rem !important; height: 8rem !important; border-width: 8px !important; }
            .text-2xl { font-size: 1.25rem !important; } /* Texto % gauge */
            
            /* Gráficos más bajos */
            #chart-trend, #chart-pareto { height: 160px !important; min-height: 0 !important; }
            .h-56 { height: 10rem !important; } /* Contenedor grafico original */
            
            /* Grids más compactos */
            .gap-6 { gap: 0.75rem !important; }
            .p-5 { padding: 0.75rem !important; }
            .p-6 { padding: 1rem !important; }
            
            /* Ajuste Detalle Individual para Paginas de 8 */
            /* Ajuste Detalle Individual para Paginas de 8 */
            /* Ajuste Detalle Individual - CLASE FORZADA VIA JS */
            .tv-grid-override {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 1.5rem !important; /* Gap un poco mas grande para aire */
                justify-content: flex-start !important;
                align-content: flex-start !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0.5rem !important;
            }
            .tv-grid-override > div {
                flex: 0 0 23% !important; 
                max-width: 23% !important; 
                margin-bottom: 0 !important;
                display: none; /* Oculto por defecto, se activa con clase */
            }
            
            /* Clase para mostrar cards activas */
            .tv-page-active { display: flex !important; flex-direction: column !important; }
            
            /* Animaciones */
            #tab-global, #tab-detalle { animation: fadeIn 0.5s ease-in-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(style);

        // FORZAR REMOCION DE GRID TAILWIND
        const container = document.querySelector('#tab-detalle > div');
        if(container) {
            // Reemplazamos TODAS las clases por nuestra clase maestra
            container.className = 'tv-grid-override';
        }

        // LÓGICA DE ROTACIÓN Y PAGINACIÓN
        // Selector actualizado para usar la nueva clase o el hijo directo
        const cards = document.querySelectorAll('.tv-grid-override > div');
        const CARDS_PER_PAGE = 8;
        const totalPages = Math.ceil(cards.length / CARDS_PER_PAGE);
        let currentStep = -1; // -1 = Resumen Global, 0..N = Paginas de detalle

        function showPage(pageIndex) {
            cards.forEach((card, index) => {
                if (pageIndex === -1) {
                    card.classList.remove('tv-page-active'); // Ocultar todo si es resumen
                } else {
                    const start = pageIndex * CARDS_PER_PAGE;
                    const end = start + CARDS_PER_PAGE;
                    if (index >= start && index < end) {
                        card.classList.add('tv-page-active');
                    } else {
                        card.classList.remove('tv-page-active');
                    }
                }
            });
        }

        setInterval(() => {
            currentStep++;
            // Ciclo: Global -> Pag 0 -> Pag 1 -> ... -> Global
            if (currentStep >= totalPages) {
                currentStep = -1;
            }

            if (currentStep === -1) {
                switchTab('tab-global');
            } else {
                switchTab('tab-detalle');
                showPage(currentStep);
            }
        }, 20000);
        
        // Refresh total de datos cada 5 minutos
        setTimeout(() => { location.reload(); }, 300000);
    })();
    
    // FULLSCREEN TOGGLE LOGIC
    const fsToggle = document.getElementById('tv-fullscreen-toggle');
    if(fsToggle) {
        fsToggle.addEventListener('click', () => {
             if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.error(`Error attempting to enable fullscreen: ${e.message} (${e.name})`);
                });
                fsToggle.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fsToggle.innerHTML = '<i class="fas fa-expand"></i>';
                }
            }
        });
    }
    {% endif %}

    // --- GRÁFICOS APEX ---
    document.addEventListener('DOMContentLoaded', function() {
        const trendData = JSON.parse('{{ history_trend|safe }}');
        const paretoData = JSON.parse('{{ pareto_data|safe }}');

        if(document.getElementById('chart-trend')) {
            new ApexCharts(document.getElementById('chart-trend'), {
                series: [{ name: 'OEE Global', data: trendData.map(i => i.oee) }],
                chart: { height: '100%', type: 'line', toolbar: { show: false }, foreColor: '#94a3b8' },
                stroke: { curve: 'smooth', width: 4 },
                xaxis: { categories: trendData.map(i => i.day) },
                yaxis: { max: 100 },
                grid: { borderColor: '#334155' }
            }).render();
        }

        if(document.getElementById('chart-pareto')) {
            new ApexCharts(document.getElementById('chart-pareto'), {
                series: [{ name: 'Horas', data: paretoData.map(i => i.value) }],
                chart: { height: '100%', type: 'bar', toolbar: { show: false }, foreColor: '#94a3b8' },
                plotOptions: { bar: { borderRadius: 4, distributed: true, horizontal: true } },
                xaxis: { categories: paretoData.map(i => i.label) },
                legend: { show: false }
            }).render();
        }
    });
</script>
{% endblock %}
