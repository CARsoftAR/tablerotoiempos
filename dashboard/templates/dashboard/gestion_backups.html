{% extends 'base.html' %}
{% load static %}

{% block title %}Sistema de Backup - ABBAMAT{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;700;900&display=swap');

    :root {
        --premium-gold: #d4af37;
        --gold-light: #f4e4b7;
        --gold-dark: #b8941e;
        --gold-bright: #ffd700;
        --accent-gold: rgba(212, 175, 55, 0.8);
        --dark-bg: #050505;
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --font-brand: 'Outfit', sans-serif;
    }

    body {
        background-color: var(--dark-bg);
        background-image: 
            radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 40%);
        font-family: var(--font-brand);
    }

    .backup-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .backup-header {
        position: relative;
        padding: 60px;
        background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.95) 100%);
        border: 1px solid var(--glass-border);
        border-radius: 40px;
        margin-bottom: 40px;
        overflow: hidden;
        backdrop-filter: blur(20px);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
    }

    .header-glow {
        position: absolute;
        top: -50%;
        left: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
        transform: rotate(-45deg);
        pointer-events: none;
    }

    .backup-header h1 {
        font-size: 3.5rem;
        font-weight: 900;
        margin: 0;
        line-height: 0.9;
        text-transform: uppercase;
        letter-spacing: -0.05em;
        background: linear-gradient(to bottom, #fff 0%, #aaa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .backup-header h1 span {
        background: linear-gradient(to bottom, var(--gold-bright), var(--premium-gold));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .backup-header p {
        margin-top: 15px;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 400;
        letter-spacing: 0.05em;
    }

    .github-banner {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 20px 30px;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        backdrop-filter: blur(10px);
    }

    .github-repo {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .github-repo i {
        font-size: 24px;
        color: var(--premium-gold);
    }

    .github-repo a {
        color: #fff;
        text-decoration: none;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.02em;
        opacity: 0.8;
        transition: opacity 0.3s;
    }

    .github-repo a:hover {
        opacity: 1;
        color: var(--premium-gold);
    }

    .github-status {
        display: flex;
        gap: 20px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 800;
    }

    .status-item {
        color: rgba(255, 255, 255, 0.4);
    }

    .status-item span {
        color: var(--premium-gold);
        margin-left: 5px;
    }

    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-bottom: 50px;
    }

    .premium-card {
        padding: 40px;
        border-radius: 35px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        position: relative;
        overflow: hidden;
        transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        cursor: pointer;
    }

    .premium-card:hover {
        transform: translateY(-10px);
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(212, 175, 55, 0.3);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .card-icon {
        width: 70px;
        height: 70px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: var(--premium-gold);
        margin-bottom: 25px;
        transition: all 0.5s ease;
    }

    .premium-card:hover .card-icon {
        transform: scale(1.1) rotate(5deg);
        background: var(--premium-gold);
        color: #000;
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
    }

    .premium-card h3 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #fff;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: -0.02em;
    }

    .premium-card p {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 30px;
    }

    .card-action-btn {
        width: 100%;
        padding: 18px;
        border-radius: 15px;
        border: 1px solid rgba(212, 175, 55, 0.2);
        background: transparent;
        color: var(--premium-gold);
        font-weight: 800;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .card-action-btn:hover {
        background: var(--premium-gold);
        color: #000;
        box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2);
    }

    .table-container {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 35px;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .table-header {
        padding: 30px 40px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .table-header i {
        color: var(--premium-gold);
        font-size: 20px;
    }

    .table-header h2 {
        font-size: 1.2rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #fff;
        letter-spacing: 0.1em;
        margin: 0;
    }

    .premium-table {
        width: 100%;
        border-collapse: collapse;
    }

    .premium-table th {
        padding: 20px 40px;
        text-align: left;
        font-size: 11px;
        font-weight: 800;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        border-bottom: 1px solid var(--glass-border);
    }

    .premium-table td {
        padding: 25px 40px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .premium-table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    .badge {
        padding: 6px 14px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .badge-gold { background: rgba(212, 175, 55, 0.1); color: var(--premium-gold); border: 1px solid rgba(212, 175, 55, 0.2); }
    .badge-success { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
    .badge-error { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }

    /* Modal Styling */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(15px);
    }

    .modal-content {
        position: relative;
        background: #0a0a0a;
        margin: 5% auto;
        padding: 50px;
        width: 90%;
        max-width: 600px;
        border-radius: 40px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 40px 80px rgba(0, 0, 0, 0.8);
    }

    .modal-content h2 {
        font-size: 2rem;
        font-weight: 900;
        text-transform: uppercase;
        color: #fff;
        margin-bottom: 30px;
        letter-spacing: -0.02em;
    }

    .modal-content h2 span { color: var(--premium-gold); }

    .input-group {
        margin-bottom: 30px;
    }

    .input-group label {
        display: block;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--premium-gold);
        margin-bottom: 12px;
        letter-spacing: 0.1em;
    }

    .input-group textarea, .input-group input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 15px;
        padding: 20px;
        color: #fff;
        font-family: var(--font-brand);
        font-size: 14px;
        transition: all 0.3s;
    }

    .input-group textarea:focus {
        outline: none;
        border-color: var(--premium-gold);
        background: rgba(255, 255, 255, 0.08);
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-modal {
        flex: 1;
        padding: 18px;
        border-radius: 15px;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel { background: transparent; border: 1px solid var(--glass-border); color: #666; }
    .btn-cancel:hover { color: #fff; border-color: #fff; }

    .btn-confirm { background: var(--premium-gold); border: none; color: #000; }
    .btn-confirm:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3); }

    .close-modal {
        position: absolute;
        top: 30px;
        right: 30px;
        font-size: 24px;
        color: #333;
        cursor: pointer;
        transition: color 0.3s;
    }

    .close-modal:hover { color: #fff; }

    .loading {
        display: none;
        margin-bottom: 25px;
        text-align: center;
    }
    .loading.active {
        display: block;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(212, 175, 55, 0.1);
        border-radius: 50%;
        border-top-color: var(--premium-gold);
        animation: spin 1s ease-in-out infinite;
        margin: 0 auto 15px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

</style>

<div class="backup-container animate-in fade-in duration-700">
    
    <!-- Premium Header -->
    <div class="backup-header">
        <div class="header-glow"></div>
        <div class="relative z-10">
            <h1>SISTEMA DE <span>RESPALDO</span></h1>
            <p>Blindaje integral de datos: Base de Datos SQL + Código Fuente del Sistema</p>
        </div>
    </div>

    <!-- GitHub Connectivity -->
    <div class="github-banner">
        <div class="github-repo">
            <i class="fab fa-github"></i>
            <div>
                <span class="block text-[8px] font-black text-amber-500 uppercase tracking-widest mb-1">Mirror Remoto</span>
                <a href="https://github.com/CARsoftAR/tablerotoiempos.git" target="_blank">CARsoftAR/tablerotoiempos.git</a>
            </div>
        </div>
        <div class="github-status">
            <div class="status-item">RAMA: <span>main</span></div>
            <div class="status-item">ÚLTIMO SYNC: <span>{% now "d/m/Y H:i" %}</span></div>
        </div>
    </div>

    <!-- Action Control Panels -->
    <div class="action-grid">
        <!-- Generar Snapshot -->
        <div class="premium-card" onclick="openCreateModal()">
            <div class="card-icon">
                <i class="fas fa-save"></i>
            </div>
            <h3>Generar Snapshot</h3>
            <p>Captura el estado actual de la planta. Se genera un volcado SQL y un paquete ZIP con los recursos del manual y el código.</p>
            <button class="card-action-btn">
                <i class="fas fa-plus-circle mr-2"></i> Iniciar Proceso
            </button>
        </div>

        <!-- Mirror Cloud -->
        <div class="premium-card" onclick="openGithubModal()">
            <div class="card-icon">
                <i class="fab fa-github"></i>
            </div>
            <h3>Espejo en la Nube</h3>
            <p>Sincroniza el repositorio local con el servidor central de GitHub. Ideal para backup físico ante rotura de disco en servidor local.</p>
            <button class="card-action-btn">
                <i class="fas fa-cloud-upload-alt mr-2"></i> Sincronizar Mirror
            </button>
        </div>
    </div>

    <!-- Historical Data Table -->
    <div class="table-container shadow-2xl">
        <div class="table-header">
            <i class="fas fa-history"></i>
            <h2>Registro de Actividad</h2>
        </div>

        {% if backups %}
        <table class="premium-table">
            <thead>
                <tr>
                    <th>Origen</th>
                    <th>Cronología</th>
                    <th>Operador</th>
                    <th>Carga</th>
                    <th>Estado</th>
                    <th>Acciones de Centro</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr>
                    <td>
                        {% if backup.tipo == 'MYSQL' %}
                            <span class="badge badge-gold"><i class="fas fa-database mr-1"></i> SQL</span>
                        {% else %}
                            <span class="badge badge-gold"><i class="fas fa-box-open mr-1"></i> SNAPSHOT</span>
                        {% endif %}
                    </td>
                    <td class="font-bold text-white">{{ backup.fecha_creacion|date:"d M Y" }} <span class="opacity-30 ml-2 font-normal">{{ backup.fecha_creacion|date:"H:i" }}</span></td>
                    <td class="text-amber-400/60 font-black">{{ backup.usuario|default:"ROOT_SYSTEM" }}</td>
                    <td class="font-mono text-[11px] font-bold">
                        {% if backup.tamano_total_mb < 1 %}
                            {{ backup.tamano_total_mb|floatformat:2 }} <span class="text-[9px] opacity-40">MB</span>
                        {% else %}
                            {{ backup.tamano_total_mb|floatformat:0 }} <span class="text-[9px] opacity-40">MB</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if backup.estado == 'EXITOSO' %}
                            <span class="badge badge-success">Verificado</span>
                        {% elif backup.estado == 'ERROR' %}
                            <span class="badge badge-error">Corrupto</span>
                        {% else %}
                            <span class="badge badge-success">Restaurado</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex gap-4">
                            {% if backup.archivo_db %}
                            <button class="text-white/40 hover:text-amber-400 transition-colors" onclick="downloadBackup({{ backup.id }}, 'db')" title="Descargar DB">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="text-white/40 hover:text-emerald-400 transition-colors" onclick="confirmRestore({{ backup.id }})" title="Restaurar Snapshot">
                                <i class="fas fa-undo"></i>
                            </button>
                            {% endif %}
                            <button class="text-white/40 hover:text-rose-500 transition-colors" onclick="confirmDelete({{ backup.id }})" title="Eliminar Registro">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-40 opacity-20">
            <i class="fas fa-database text-8xl mb-8"></i>
            <h3 class="uppercase tracking-[0.5em] font-black text-xs">Sin Actividad Registrada</h3>
        </div>
        {% endif %}
    </div>

</div>

</div>

<!-- Modals -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeCreateModal()">&times;</span>
        <h2>CREAR <span>SNAPSHOT</span></h2>
        
        <form id="createBackupForm" method="POST" action="{% url 'crear_backup' %}">
            {% csrf_token %}
            <input type="hidden" id="tipo" name="tipo" value="COMPLETO">

            <div class="input-group">
                <label>Notas Técnicas</label>
                <textarea id="notas" name="notas" placeholder="Describa el motivo del snapshot (ej. Antes de mantenimiento de servidor)..."></textarea>
            </div>

            <div id="loadingCreate" class="loading">
                <div class="spinner"></div>
                <p class="text-amber-400 font-black animate-pulse uppercase tracking-widest text-xs" style="text-align: center;">Procesando volcado de sistema...</p>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="closeCreateModal()">Cancelar</button>
                <button type="submit" class="btn-modal btn-confirm">Confirmar SNAPSHOT</button>
            </div>
        </form>
    </div>
</div>

<div id="githubModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeGithubModal()">&times;</span>
        <h2>SYNC <span>GITHUB</span></h2>
        
        <form id="githubSyncForm">
            {% csrf_token %}
            <div class="input-group">
                <label>Mensaje de Sincronización</label>
                <textarea id="mensaje_github" name="mensaje" placeholder="Describa los cambios realizados en el sistema..."></textarea>
            </div>

            <div id="loadingGithub" class="loading">
                <div class="spinner"></div>
                <p class="text-blue-400 font-black animate-pulse uppercase tracking-widest text-xs" style="text-align: center;">Pusheando cambios a la nube...</p>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="closeGithubModal()">Ignorar</button>
                <button type="submit" class="btn-modal btn-confirm" style="background: #1d4ed8; color: #fff;">Sincronizar Ahora</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmación de Acción Crítica -->
<div id="confirmModal" class="modal">
    <div class="modal-content text-center">
        <div class="w-16 h-16 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center text-3xl mx-auto mb-6">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 id="confirmTitle" class="!mb-4">ACCIÓN <span>PELIGROSA</span></h2>
        <p id="confirmMessage" class="text-slate-400 mb-10 text-sm leading-relaxed"></p>
        
        <div class="modal-actions">
            <button type="button" class="btn-modal btn-cancel" onclick="closeConfirmModal()">Abortar</button>
            <button id="confirmButton" class="btn-modal btn-confirm" style="background: #ef4444; color: #fff;">Ejecutar Acción</button>
        </div>
    </div>
</div>

<div id="alertModal" class="modal">
    <div class="modal-content text-center">
        <div id="alertIconContainer" class="w-16 h-16 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center text-3xl mx-auto mb-6">
            <i id="alertIcon" class="fas fa-info-circle"></i>
        </div>
        <h2 id="alertTitle" class="!mb-4 uppercase tracking-tighter">SISTEMA <span>INFO</span></h2>
        <p id="alertMessage" class="text-slate-400 mb-10 text-sm leading-relaxed"></p>
        
        <div class="modal-actions" style="justify-content: center;">
            <button type="button" class="btn-modal btn-confirm" onclick="closeAlertModal()">Entendido</button>
        </div>
    </div>
</div>

<script>
// ========== FUNCIONES DE MODALES PREMIUM ==========

// Modal de Confirmación
function showConfirm(message, title = 'Confirmar Acción', callback) {
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'block';
    
    document.getElementById('confirmButton').onclick = function() {
        closeConfirmModal();
        if (callback) callback();
    };
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Modal de Alerta
function showAlert(message, type = 'info') {
    const alertIcon = document.getElementById('alertIcon');
    const alertTitle = document.getElementById('alertTitle');
    const alertContainer = document.getElementById('alertIconContainer');
    
    // Configurar ícono y título según el tipo
    if (type === 'success') {
        alertIcon.className = 'fas fa-check-circle';
        alertContainer.className = 'w-16 h-16 rounded-full bg-emerald-500/20 text-emerald-500 flex items-center justify-center text-3xl mx-auto mb-6';
        alertTitle.innerHTML = 'SISTEMA <span>EXITO</span>';
    } else if (type === 'error') {
        alertIcon.className = 'fas fa-times-circle';
        alertContainer.className = 'w-16 h-16 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center text-3xl mx-auto mb-6';
        alertTitle.innerHTML = 'SISTEMA <span>ERROR</span>';
    } else if (type === 'warning') {
        alertIcon.className = 'fas fa-exclamation-triangle';
        alertContainer.className = 'w-16 h-16 rounded-full bg-amber-500/20 text-amber-500 flex items-center justify-center text-3xl mx-auto mb-6';
        alertTitle.innerHTML = 'SISTEMA <span>AVISO</span>';
    } else {
        alertIcon.className = 'fas fa-info-circle';
        alertContainer.className = 'w-16 h-16 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center text-3xl mx-auto mb-6';
        alertTitle.innerHTML = 'SISTEMA <span>INFO</span>';
    }
    
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('alertModal').style.display = 'block';
}

function closeAlertModal() {
    document.getElementById('alertModal').style.display = 'none';
}

function openGithubModal() {
    document.getElementById('githubModal').style.display = 'block';
}

function closeGithubModal() {
    document.getElementById('githubModal').style.display = 'none';
    document.getElementById('githubSyncForm').reset();
    document.getElementById('loadingGithub').classList.remove('active');
}

// GitHub Sync logic
document.getElementById('githubSyncForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const loading = document.getElementById('loadingGithub');
    loading.classList.add('active');
    
    const formData = new FormData(this);
    
    fetch('{% url "sincronizar_github" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.classList.remove('active');
        if (data.status === 'success') {
            closeGithubModal();
            showAlert('✅ ' + data.message + '\nCommit: ' + data.commit, 'success');
            setTimeout(() => location.reload(), 2000);
        } else if (data.status === 'info') {
            closeGithubModal();
            showAlert('ℹ️ ' + data.message, 'info');
        } else {
            showAlert('❌ ' + data.message, 'error');
        }
    })
    .catch(error => {
        loading.classList.remove('active');
        showAlert('❌ Error de red: ' + error, 'error');
    });
});

// ========== FUNCIONES DE BACKUP ==========

// Modal Functions
function openCreateModal() {
    document.getElementById('createModal').style.display = 'block';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createBackupForm').reset();
    document.getElementById('loadingCreate').classList.remove('active');
}

// Create Backup
document.getElementById('createBackupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const loading = document.getElementById('loadingCreate');
    loading.classList.add('active');
    
    const formData = new FormData(this);
    
    fetch('{% url "crear_backup" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.classList.remove('active');
        closeCreateModal();
        if (data.status === 'success') {
            showAlert('Backup creado exitosamente: ' + data.tamano_mb.toFixed(2) + ' MB', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        loading.classList.remove('active');
        closeCreateModal();
        showAlert('Error al crear backup: ' + error, 'error');
    });
});

// Download Backup
function downloadBackup(backupId, tipo) {
    window.location.href = `/dashboard/backup/descargar/${backupId}/?tipo=${tipo}`;
}

// Confirm Restore
function confirmRestore(backupId) {
    showConfirm(
        '⚠️ ADVERTENCIA: Esta operación sobrescribirá la base de datos actual.\n\n¿Estás seguro de que deseas restaurar este backup?',
        'Confirmar Restauración',
        function() {
            const loading = document.createElement('div');
            loading.className = 'loading active';
            loading.style.position = 'fixed';
            loading.style.top = '50%';
            loading.style.left = '50%';
            loading.style.transform = 'translate(-50%, -50%)';
            loading.style.background = 'white';
            loading.style.padding = '40px';
            loading.style.borderRadius = '20px';
            loading.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3)';
            loading.style.zIndex = '10000';
            loading.innerHTML = '<div class="spinner"></div><p style="color: var(--text-dark); font-weight: 600;">Restaurando backup...</p>';
            document.body.appendChild(loading);
            
            fetch(`/dashboard/backup/restaurar/${backupId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.body.removeChild(loading);
                if (data.status === 'success') {
                    showAlert('Base de datos restaurada exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                document.body.removeChild(loading);
                showAlert('Error al restaurar: ' + error, 'error');
            });
        }
    );
}

// Confirm Delete
function confirmDelete(backupId) {
    showConfirm(
        '¿Estás seguro de que deseas eliminar este backup?\n\nEsta acción no se puede deshacer.',
        'Confirmar Eliminación',
        function() {
            fetch(`/dashboard/backup/eliminar/${backupId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Backup eliminado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error al eliminar: ' + error, 'error');
            });
        }
    );
}

// Close modal on outside click
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        if (event.target.id === 'createModal') closeCreateModal();
        if (event.target.id === 'githubModal') closeGithubModal();
        if (event.target.id === 'confirmModal') closeConfirmModal();
        if (event.target.id === 'alertModal') closeAlertModal();
    }
}
</script>

{% endblock %}
